(function () {
    "use strict";

    var app = angular.module("geofeelings", ["ngRoute"]);

    app.config(function ($routeProvider) {
        $routeProvider
            .when("/admin", {
                templateUrl: "./controllers/adminController/admin.html"
            }).when("/search", {
                templateUrl: "./controllers/searchController/search.html"
            }).when("/intro", {
                templateUrl: "./controllers/introController/intro.html"
            }).when("/help", {
                templateUrl: "./directives/help.html"
            }).when("/login", {
                templateUrl: "./controllers/loginController/login.html"
            }).when("/register", {
                templateUrl: "./controllers/loginController/register.html"
            }).when("/password", {
                templateUrl: "./controllers/loginController/password.html"
            }).when("/user", {
                templateUrl: "./controllers/userController/user.html"
            }).when("/user/:param", {
                templateUrl: "./controllers/userController/user.html",
                controller: 'userController'
            }).when("/me", {
                templateUrl: "./controllers/userController/me.html"
            }).when("/event", {
                templateUrl: "./controllers/eventController/event.html"
            }).when("/addEvent", {
                templateUrl: "./controllers/eventController/addEvent.html"
            }).when("/location", {
                templateUrl: "./controllers/locationController/location.html"
            }).otherwise({
                redirectTo: "/intro"
            });
    });

    app.directive("searchresult", function () {
        return {
            restrict: 'E',
            templateUrl: 'directives/searchResult.html'
        };
    });

    app.service('sharedProperties', function () {
        var property = 'First';

        return {
            getProperty: function () {
                return property;
            },
            setProperty: function (value) {
                property = value;
            }
        };
    });

})();

/**
 * Created by Jonatan on 6/12/2015.
 */

(function () {
    "use strict";

    var adminController = function ($scope) {

    };

    angular.module("geofeelings").controller("adminController", ["$scope", adminController]);
})();
/**
 * Created by Jonatan on 4/12/2015.
 */


(function () {
    "use strict";

    var eventController = function ($scope) {

    };

    angular.module("geofeelings").controller("eventController", ["$scope", eventController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var introController = function ($scope) {

        $scope.sliderValue = 50;
        $scope.moodWord = null;

        //SMILEY TEKENEN
        var c = document.getElementById("smileyCanvas");
        var ctx = c.getContext("2d");
        //telkens slidervalue verandert gezichtje tekenen
        $scope.$watch("sliderValue", function (newValue, oldValue) {
            ctx.clearRect(0, 0, c.width, c.height); //canvas clearen voor nieuw frame

            var mood = $scope.sliderValue;
            giveMoodWord();
            //offset positie mond
            var offsetX = 60;
            var offSetY = 140 + (mood / 5);

            //variabelen voor beziercurve (= mond)
            var SPx = offsetX;
            var SPy = offSetY + 100 - (mood / 10 * 8);
            var H1x = offsetX;
            var H1y = offSetY + (mood / 10 * 12);
            var H2x = offsetX + 180;
            var H2y = offSetY + (mood / 10 * 12);
            var EPx = offsetX + 180;
            var EPy = offSetY + 100 - (mood / 10 * 8);

            //rood en groen bereken voor achtergrond hoofd
            var bgR = Math.round(170 - (mood / 100) * 170);
            var bgG = Math.round(mood / 100 * 132);

            //hoofd
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(150, 150, 145, 0, 2 * Math.PI);
            ctx.fillStyle = "rgb(" + bgR + "," + bgG + ",0)";
            ctx.fill();
            ctx.stroke();

            //mond

            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(SPx, SPy);
            ctx.bezierCurveTo(H1x, H1y, H2x, H2y, EPx, EPy);
            ctx.stroke();
            ctx.lineCap = "round";

            //oog links

            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(100, 100, 20, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();

            //oog rechts
            ctx.beginPath();
            ctx.arc(200, 100, 20, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();
        });

        var moodwords = ["horrible", "really bad", "bad", "okay", "good", "really good", "excellent"];
        var giveMoodWord = function () {
            if ($scope.sliderValue < 5) {
                $scope.moodWord = moodwords[0];
            }
            else if ($scope.sliderValue < 25) {
                $scope.moodWord = moodwords[1];
            }
            else if ($scope.sliderValue < 40) {
                $scope.moodWord = moodwords[2];
            }
            else if ($scope.sliderValue < 60) {
                $scope.moodWord = moodwords[3];
            }
            else if ($scope.sliderValue < 75) {
                $scope.moodWord = moodwords[4];
            }
            else if ($scope.sliderValue < 95) {
                $scope.moodWord = moodwords[5];
            }
            else {
                $scope.moodWord = moodwords[6];
            }
        }
    };

    angular.module("geofeelings").controller("introController", ["$scope", introController]);
})();
/**
 * Created by Jonatan on 6/12/2015.
 */

(function () {
    "use strict";

    var locationController = function ($scope) {

    };

    angular.module("geofeelings").controller("locationController", ["$scope", locationController]);
})();
/**
 * Created by Jonatan on 26/11/2015.
 */

(function () {
    "use strict";

    var loginController = function ($scope) {

    };

    angular.module("geofeelings").controller("loginController", ["$scope", loginController]);
})();
/**
 * Created by Jonatan on 21/11/2015.
 */

(function () {
    "use strict";

    var mainController = function ($scope) {
        if (navigator.geolocation) {
            $scope.image = "./assets/common.png";
            $scope.mapOptions = {
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true
            };

            $scope.map = new google.maps.Map(document.querySelector("#map"), $scope.mapOptions);

            navigator.geolocation.getCurrentPosition(function (position) {
                $scope.map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                $scope.marker = new google.maps.Marker({
                    position: $scope.map.getCenter(),
                    map: $scope.map,
                    icon: $scope.image
                });
            });
        } else {
            //throw exception
        }
    };

    angular.module("geofeelings").controller("mainController", ["$scope", mainController]);
})();
/**
 * Created by Jonatan on 25/11/2015.
 */


(function () {
    "use strict";

    var searchController = function ($scope, searchService, sharedProperties) {

        $scope.searchModel = null;

        $scope.searchOnSubmit = function (formObj) {
            if ($scope.searchModel.length > 0) {
                searchNow();
            }
        };
        $scope.searchOnKeyPress = function () {
            if ($scope.searchModel !== null) {
                searchNow();
            }
        };

        $scope.filterSearchResults = function (i) {
            if ($scope.searchModel === "") {
                return false;
            }

            if (i.title.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                return true;
            }
            if (i.description !== undefined) {
                if (i.description.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                    return true;
                }
            }

            return false;
        };


        var searchNow = function () {
            searchService.search($scope.searchModel).then(onResultsReady);
        };

        var onResultsReady = function (res) {
            $scope.searchResults = res;
        };

        var onResultsError = function (err) {
        };
    };

    angular.module("geofeelings").controller("searchController", ["$scope", "searchService","sharedProperties", searchController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
        "use strict";

        var userController = function ($scope, $location, searchService) {

            $scope.init = function () {
                var userid = $location.search().userid;
                searchService.searchFromId(userid).then(userFoundWithId);
                searchService.getSharesByUserId(userid).then(sharesFoundWithId);
            };

            var userFoundWithId = function (res) {
                    $scope.userfoundwithid = res;

                    $scope.map.setCenter(new google.maps.LatLng(res.lat, res.lon));
                    if ($scope.marker !== undefined) {
                        $scope.marker.setMap(null); //verwijdert alle markers eerst
                    }
                    $scope.marker = new google.maps.Marker({
                        position: {lat: res.lat, lng: res.lon},
                        map: $scope.map,
                        icon: $scope.image
                    });
                }
                ;

            var sharesFoundWithId = function (res) {

                $scope.shareFoundWithUserId = res;


                //markers plaatsen en kaart verplaatsen naar hun gemiddelde
                var minLat = 100,
                    maxLat = 0,
                    minLng = 100,
                    maxLng = 0,
                    teller = 0,
                    gemLat = 0,
                    gemLng = 0;

                $scope.marker.setMap(null); //verwijdert alle markers eerst
                res.forEach(function (res) {
                    teller++;
                    if (res.lat < minLat) {
                        minLat = res.lat;
                    }
                    else if (res.lat > maxLat) {
                        maxLat = res.lat;
                    }

                    if (res.lng < minLng) {
                        minLng = res.lng;
                    }
                    else if (res.lng > maxLng) {
                        maxLng = res.lng;
                    }

                    $scope.marker = new google.maps.Marker({
                        position: {lat: res.lat, lng: res.lng},
                        map: $scope.map,
                        icon: $scope.image
                    });

                });

                if (teller == 1) {
                    gemLat = res[0].lat;
                    gemLng = res[0].lng;
                }
                else {
                    gemLat = (maxLat - minLat) / 2 + minLat;
                    gemLng = (maxLng - minLng) / 2 + minLng;
                }

                $scope.map.setCenter(new google.maps.LatLng(gemLat, gemLng));
                $scope.map.setZoom(12);
                //klaar met markers plaatsen en kaart verplaatsen naar hun gemiddelde
            };
        };

        angular.module("geofeelings").controller("userController", ["$scope", "$location", "searchService", userController]);
    })
();
(function () {
    "use strict";

    var searchService = function ($http) {

        var search = function (searchString) {
            var url = 'http://localhost:3000/api/users';
            return $http.get(url).then(function (response) {

                var arSearchResults = [];
                angular.forEach(response.data.users.user, function (searchR) {
                    var newSR = new SearchResult(searchR.username, searchR.photoUrl, searchR.email, searchR._id.$oid);
                    arSearchResults.push(newSR);
                });
                return arSearchResults;
            });
        };

        var searchFromId = function (searchString) {
            var url = './users.json';
            return $http.get(url).then(function (response) {

                var userfound;
                angular.forEach(response.data.users.user, function (user) {
                    if (user._id.$oid == searchString) {
                        userfound = new GfUser(user._id.$oid, user.username, user.photoUrl, user.age, user.lat, user.lon);
                    }
                });
                return userfound;
            });
        };

        var getSharesByUserId = function(userid)
        {
            var url = './shares.json';
            return $http.get(url).then(function (response) {
                var sharesfound=[];
                angular.forEach(response.data.shares.share, function (share) {
                    if (share.userid == userid) {
                        var newShare = new GFShare(share._id.$oid, share.user, share.userid, share.time.$date, share.mood, share.lat, share.lng);
                        sharesfound.push(newShare);
                    }
                });
                return sharesfound;
            });
        };

        return {
            search: search,
            searchFromId: searchFromId,
            getSharesByUserId:getSharesByUserId
        };
    };
    angular.module("geofeelings").factory("searchService", ["$http", searchService]);
})();
function GFShare(id, user, userid, time, mood, lat, lng) {
    this.id = id;
    this.user = user;
    this.userid = userid;
    this.time = time;
    this.mood = mood;
    this.lat = lat;
    this.lng = lng;
}
GFShare.prototype.toString = function () {
    return this.user + " (" + this.time + ")";
};

function GfUser(id, username, photoUrl, age, lat, lon) {
    this.id = id;
    this.username = username;
    this.photoUrl = photoUrl;
    this.age = age;
    this.lat = lat;
    this.lon = lon;
}
GfUser.prototype.toString = function () {
    return this.username;
};

GfUser.prototype.agenow = function () {
    var birthday = new Date(this.age.date);
    var age = Date.now() - birthday;
    console.log(age);
};

function SearchResult(title, photoUrl, description, id)
{
    this.title = title;
    this.photoUrl = photoUrl;
    this.description = description;
    this.id = id;
}
SearchResult.prototype.toString = function() {
    return this.title;
};

/**
 * Created by Jonatan on 22/11/2015.
 */

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImFkbWluQ29udHJvbGxlci9hZG1pbkNvbnRyb2xsZXIuanMiLCJldmVudENvbnRyb2xsZXIvZXZlbnRDb250cm9sbGVyLmpzIiwiaW50cm9Db250cm9sbGVyL2ludHJvQ29udHJvbGxlci5qcyIsImxvY2F0aW9uQ29udHJvbGxlci9sb2NhdGlvbkNvbnRyb2xsZXIuanMiLCJsb2dpbkNvbnRyb2xsZXIvbG9naW5Db250cm9sbGVyLmpzIiwibWFpbkNvbnRyb2xsZXIvbWFpbkNvbnRyb2xsZXIuanMiLCJzZWFyY2hDb250cm9sbGVyL3NlYXJjaENvbnRyb2xsZXIuanMiLCJ1c2VyQ29udHJvbGxlci91c2VyQ29udHJvbGxlci5qcyIsInNlYXJjaFNlcnZpY2UuanMiLCJnZlNoYXJlLmpzIiwiZ2ZVc2VyLmpzIiwiU2VhcmNoUmVzdWx0LmpzIiwibWFwRXhjZXB0aW9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNURBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDWkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNaQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3REQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNaQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1ZBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIiwgW1wibmdSb3V0ZVwiXSk7XHJcblxyXG4gICAgYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHJvdXRlUHJvdmlkZXIpIHtcclxuICAgICAgICAkcm91dGVQcm92aWRlclxyXG4gICAgICAgICAgICAud2hlbihcIi9hZG1pblwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2FkbWluQ29udHJvbGxlci9hZG1pbi5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9zZWFyY2hcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9zZWFyY2hDb250cm9sbGVyL3NlYXJjaC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9pbnRyb1wiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2ludHJvQ29udHJvbGxlci9pbnRyby5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9oZWxwXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vZGlyZWN0aXZlcy9oZWxwLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL2xvZ2luXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvbG9naW5Db250cm9sbGVyL2xvZ2luLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3JlZ2lzdGVyXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvbG9naW5Db250cm9sbGVyL3JlZ2lzdGVyLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3Bhc3N3b3JkXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvbG9naW5Db250cm9sbGVyL3Bhc3N3b3JkLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3VzZXJcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy91c2VyQ29udHJvbGxlci91c2VyLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3VzZXIvOnBhcmFtXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvdXNlckNvbnRyb2xsZXIvdXNlci5odG1sXCIsXHJcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAndXNlckNvbnRyb2xsZXInXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvbWVcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy91c2VyQ29udHJvbGxlci9tZS5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9ldmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2V2ZW50Q29udHJvbGxlci9ldmVudC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9hZGRFdmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2V2ZW50Q29udHJvbGxlci9hZGRFdmVudC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9sb2NhdGlvblwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2xvY2F0aW9uQ29udHJvbGxlci9sb2NhdGlvbi5odG1sXCJcclxuICAgICAgICAgICAgfSkub3RoZXJ3aXNlKHtcclxuICAgICAgICAgICAgICAgIHJlZGlyZWN0VG86IFwiL2ludHJvXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAuZGlyZWN0aXZlKFwic2VhcmNocmVzdWx0XCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXN0cmljdDogJ0UnLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ2RpcmVjdGl2ZXMvc2VhcmNoUmVzdWx0Lmh0bWwnXHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC5zZXJ2aWNlKCdzaGFyZWRQcm9wZXJ0aWVzJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBwcm9wZXJ0eSA9ICdGaXJzdCc7XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGdldFByb3BlcnR5OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvcGVydHk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNldFByb3BlcnR5OiBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHByb3BlcnR5ID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcblxyXG59KSgpO1xyXG4iLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDYvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGFkbWluQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImFkbWluQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgYWRtaW5Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiA0LzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgZXZlbnRDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiZXZlbnRDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBldmVudENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDEvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGludHJvQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNsaWRlclZhbHVlID0gNTA7XHJcbiAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy9TTUlMRVkgVEVLRU5FTlxyXG4gICAgICAgIHZhciBjID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzbWlsZXlDYW52YXNcIik7XHJcbiAgICAgICAgdmFyIGN0eCA9IGMuZ2V0Q29udGV4dChcIjJkXCIpO1xyXG4gICAgICAgIC8vdGVsa2VucyBzbGlkZXJ2YWx1ZSB2ZXJhbmRlcnQgZ2V6aWNodGplIHRla2VuZW5cclxuICAgICAgICAkc2NvcGUuJHdhdGNoKFwic2xpZGVyVmFsdWVcIiwgZnVuY3Rpb24gKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xyXG4gICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsgLy9jYW52YXMgY2xlYXJlbiB2b29yIG5pZXV3IGZyYW1lXHJcblxyXG4gICAgICAgICAgICB2YXIgbW9vZCA9ICRzY29wZS5zbGlkZXJWYWx1ZTtcclxuICAgICAgICAgICAgZ2l2ZU1vb2RXb3JkKCk7XHJcbiAgICAgICAgICAgIC8vb2Zmc2V0IHBvc2l0aWUgbW9uZFxyXG4gICAgICAgICAgICB2YXIgb2Zmc2V0WCA9IDYwO1xyXG4gICAgICAgICAgICB2YXIgb2ZmU2V0WSA9IDE0MCArIChtb29kIC8gNSk7XHJcblxyXG4gICAgICAgICAgICAvL3ZhcmlhYmVsZW4gdm9vciBiZXppZXJjdXJ2ZSAoPSBtb25kKVxyXG4gICAgICAgICAgICB2YXIgU1B4ID0gb2Zmc2V0WDtcclxuICAgICAgICAgICAgdmFyIFNQeSA9IG9mZlNldFkgKyAxMDAgLSAobW9vZCAvIDEwICogOCk7XHJcbiAgICAgICAgICAgIHZhciBIMXggPSBvZmZzZXRYO1xyXG4gICAgICAgICAgICB2YXIgSDF5ID0gb2ZmU2V0WSArIChtb29kIC8gMTAgKiAxMik7XHJcbiAgICAgICAgICAgIHZhciBIMnggPSBvZmZzZXRYICsgMTgwO1xyXG4gICAgICAgICAgICB2YXIgSDJ5ID0gb2ZmU2V0WSArIChtb29kIC8gMTAgKiAxMik7XHJcbiAgICAgICAgICAgIHZhciBFUHggPSBvZmZzZXRYICsgMTgwO1xyXG4gICAgICAgICAgICB2YXIgRVB5ID0gb2ZmU2V0WSArIDEwMCAtIChtb29kIC8gMTAgKiA4KTtcclxuXHJcbiAgICAgICAgICAgIC8vcm9vZCBlbiBncm9lbiBiZXJla2VuIHZvb3IgYWNodGVyZ3JvbmQgaG9vZmRcclxuICAgICAgICAgICAgdmFyIGJnUiA9IE1hdGgucm91bmQoMTcwIC0gKG1vb2QgLyAxMDApICogMTcwKTtcclxuICAgICAgICAgICAgdmFyIGJnRyA9IE1hdGgucm91bmQobW9vZCAvIDEwMCAqIDEzMik7XHJcblxyXG4gICAgICAgICAgICAvL2hvb2ZkXHJcbiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSA1O1xyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7XHJcbiAgICAgICAgICAgIGN0eC5hcmMoMTUwLCAxNTAsIDE0NSwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gXCJyZ2IoXCIgKyBiZ1IgKyBcIixcIiArIGJnRyArIFwiLDApXCI7XHJcbiAgICAgICAgICAgIGN0eC5maWxsKCk7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKTtcclxuXHJcbiAgICAgICAgICAgIC8vbW9uZFxyXG5cclxuICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDEwO1xyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7XHJcbiAgICAgICAgICAgIGN0eC5tb3ZlVG8oU1B4LCBTUHkpO1xyXG4gICAgICAgICAgICBjdHguYmV6aWVyQ3VydmVUbyhIMXgsIEgxeSwgSDJ4LCBIMnksIEVQeCwgRVB5KTtcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpO1xyXG4gICAgICAgICAgICBjdHgubGluZUNhcCA9IFwicm91bmRcIjtcclxuXHJcbiAgICAgICAgICAgIC8vb29nIGxpbmtzXHJcblxyXG4gICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTtcclxuICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICAgICAgICBjdHguYXJjKDEwMCwgMTAwLCAyMCwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ2JsYWNrJztcclxuICAgICAgICAgICAgY3R4LmZpbGwoKTtcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpO1xyXG5cclxuICAgICAgICAgICAgLy9vb2cgcmVjaHRzXHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4LmFyYygyMDAsIDEwMCwgMjAsIDAsIDIgKiBNYXRoLlBJKTtcclxuICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdibGFjayc7XHJcbiAgICAgICAgICAgIGN0eC5maWxsKCk7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIG1vb2R3b3JkcyA9IFtcImhvcnJpYmxlXCIsIFwicmVhbGx5IGJhZFwiLCBcImJhZFwiLCBcIm9rYXlcIiwgXCJnb29kXCIsIFwicmVhbGx5IGdvb2RcIiwgXCJleGNlbGxlbnRcIl07XHJcbiAgICAgICAgdmFyIGdpdmVNb29kV29yZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDUpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1swXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCAyNSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzFdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDQwKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbMl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoJHNjb3BlLnNsaWRlclZhbHVlIDwgNjApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1szXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA3NSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzRdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDk1KSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbNV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbNl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImludHJvQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgaW50cm9Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiA2LzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBsb2NhdGlvbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XHJcblxyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJsb2NhdGlvbkNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIGxvY2F0aW9uQ29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjYvMTEvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGxvZ2luQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUpIHtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImxvZ2luQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgbG9naW5Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyMS8xMS8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgbWFpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XHJcbiAgICAgICAgaWYgKG5hdmlnYXRvci5nZW9sb2NhdGlvbikge1xyXG4gICAgICAgICAgICAkc2NvcGUuaW1hZ2UgPSBcIi4vYXNzZXRzL2NvbW1vbi5wbmdcIjtcclxuICAgICAgICAgICAgJHNjb3BlLm1hcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICB6b29tOiAxNSxcclxuICAgICAgICAgICAgICAgIG1hcFR5cGVJZDogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVAsXHJcbiAgICAgICAgICAgICAgICBkaXNhYmxlRGVmYXVsdFVJOiB0cnVlXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAkc2NvcGUubWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI21hcFwiKSwgJHNjb3BlLm1hcE9wdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXAuc2V0Q2VudGVyKG5ldyBnb29nbGUubWFwcy5MYXRMbmcocG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLCBwb3NpdGlvbi5jb29yZHMubG9uZ2l0dWRlKSk7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICRzY29wZS5tYXAuZ2V0Q2VudGVyKCksXHJcbiAgICAgICAgICAgICAgICAgICAgbWFwOiAkc2NvcGUubWFwLFxyXG4gICAgICAgICAgICAgICAgICAgIGljb246ICRzY29wZS5pbWFnZVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vdGhyb3cgZXhjZXB0aW9uXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJtYWluQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgbWFpbkNvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDI1LzExLzIwMTUuXHJcbiAqL1xyXG5cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgc2VhcmNoQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsIHNlYXJjaFNlcnZpY2UsIHNoYXJlZFByb3BlcnRpZXMpIHtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE1vZGVsID0gbnVsbDtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE9uU3VibWl0ID0gZnVuY3Rpb24gKGZvcm1PYmopIHtcclxuICAgICAgICAgICAgaWYgKCRzY29wZS5zZWFyY2hNb2RlbC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hOb3coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE9uS2V5UHJlc3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2VhcmNoTW9kZWwgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaE5vdygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmZpbHRlclNlYXJjaFJlc3VsdHMgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgICBpZiAoJHNjb3BlLnNlYXJjaE1vZGVsID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpLnRpdGxlLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigkc2NvcGUuc2VhcmNoTW9kZWwudG9Mb2NhbGVMb3dlckNhc2UoKSkgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGkuZGVzY3JpcHRpb24gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGkuZGVzY3JpcHRpb24udG9Mb3dlckNhc2UoKS5pbmRleE9mKCRzY29wZS5zZWFyY2hNb2RlbC50b0xvY2FsZUxvd2VyQ2FzZSgpKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9O1xyXG5cclxuXHJcbiAgICAgICAgdmFyIHNlYXJjaE5vdyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgc2VhcmNoU2VydmljZS5zZWFyY2goJHNjb3BlLnNlYXJjaE1vZGVsKS50aGVuKG9uUmVzdWx0c1JlYWR5KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgb25SZXN1bHRzUmVhZHkgPSBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5zZWFyY2hSZXN1bHRzID0gcmVzO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBvblJlc3VsdHNFcnJvciA9IGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJzZWFyY2hDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcInNlYXJjaFNlcnZpY2VcIixcInNoYXJlZFByb3BlcnRpZXNcIiwgc2VhcmNoQ29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMS8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgICAgIHZhciB1c2VyQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRsb2NhdGlvbiwgc2VhcmNoU2VydmljZSkge1xyXG5cclxuICAgICAgICAgICAgJHNjb3BlLmluaXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdXNlcmlkID0gJGxvY2F0aW9uLnNlYXJjaCgpLnVzZXJpZDtcclxuICAgICAgICAgICAgICAgIHNlYXJjaFNlcnZpY2Uuc2VhcmNoRnJvbUlkKHVzZXJpZCkudGhlbih1c2VyRm91bmRXaXRoSWQpO1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoU2VydmljZS5nZXRTaGFyZXNCeVVzZXJJZCh1c2VyaWQpLnRoZW4oc2hhcmVzRm91bmRXaXRoSWQpO1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgdmFyIHVzZXJGb3VuZFdpdGhJZCA9IGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXNlcmZvdW5kd2l0aGlkID0gcmVzO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubWFwLnNldENlbnRlcihuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHJlcy5sYXQsIHJlcy5sb24pKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLm1hcmtlciAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5tYXJrZXIuc2V0TWFwKG51bGwpOyAvL3ZlcndpamRlcnQgYWxsZSBtYXJrZXJzIGVlcnN0XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5tYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHtsYXQ6IHJlcy5sYXQsIGxuZzogcmVzLmxvbn0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcDogJHNjb3BlLm1hcCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbjogJHNjb3BlLmltYWdlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICA7XHJcblxyXG4gICAgICAgICAgICB2YXIgc2hhcmVzRm91bmRXaXRoSWQgPSBmdW5jdGlvbiAocmVzKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNoYXJlRm91bmRXaXRoVXNlcklkID0gcmVzO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAvL21hcmtlcnMgcGxhYXRzZW4gZW4ga2FhcnQgdmVycGxhYXRzZW4gbmFhciBodW4gZ2VtaWRkZWxkZVxyXG4gICAgICAgICAgICAgICAgdmFyIG1pbkxhdCA9IDEwMCxcclxuICAgICAgICAgICAgICAgICAgICBtYXhMYXQgPSAwLFxyXG4gICAgICAgICAgICAgICAgICAgIG1pbkxuZyA9IDEwMCxcclxuICAgICAgICAgICAgICAgICAgICBtYXhMbmcgPSAwLFxyXG4gICAgICAgICAgICAgICAgICAgIHRlbGxlciA9IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2VtTGF0ID0gMCxcclxuICAgICAgICAgICAgICAgICAgICBnZW1MbmcgPSAwO1xyXG5cclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXJrZXIuc2V0TWFwKG51bGwpOyAvL3ZlcndpamRlcnQgYWxsZSBtYXJrZXJzIGVlcnN0XHJcbiAgICAgICAgICAgICAgICByZXMuZm9yRWFjaChmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVsbGVyKys7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5sYXQgPCBtaW5MYXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWluTGF0ID0gcmVzLmxhdDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmVzLmxhdCA+IG1heExhdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhMYXQgPSByZXMubGF0O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5sbmcgPCBtaW5MbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWluTG5nID0gcmVzLmxuZztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmVzLmxuZyA+IG1heExuZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhMbmcgPSByZXMubG5nO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjoge2xhdDogcmVzLmxhdCwgbG5nOiByZXMubG5nfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiAkc2NvcGUubWFwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpY29uOiAkc2NvcGUuaW1hZ2VcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGVsbGVyID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBnZW1MYXQgPSByZXNbMF0ubGF0O1xyXG4gICAgICAgICAgICAgICAgICAgIGdlbUxuZyA9IHJlc1swXS5sbmc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBnZW1MYXQgPSAobWF4TGF0IC0gbWluTGF0KSAvIDIgKyBtaW5MYXQ7XHJcbiAgICAgICAgICAgICAgICAgICAgZ2VtTG5nID0gKG1heExuZyAtIG1pbkxuZykgLyAyICsgbWluTG5nO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXAuc2V0Q2VudGVyKG5ldyBnb29nbGUubWFwcy5MYXRMbmcoZ2VtTGF0LCBnZW1MbmcpKTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXAuc2V0Wm9vbSgxMik7XHJcbiAgICAgICAgICAgICAgICAvL2tsYWFyIG1ldCBtYXJrZXJzIHBsYWF0c2VuIGVuIGthYXJ0IHZlcnBsYWF0c2VuIG5hYXIgaHVuIGdlbWlkZGVsZGVcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJ1c2VyQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkbG9jYXRpb25cIiwgXCJzZWFyY2hTZXJ2aWNlXCIsIHVzZXJDb250cm9sbGVyXSk7XHJcbiAgICB9KVxyXG4oKTsiLCIoZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIHNlYXJjaFNlcnZpY2UgPSBmdW5jdGlvbiAoJGh0dHApIHtcclxuXHJcbiAgICAgICAgdmFyIHNlYXJjaCA9IGZ1bmN0aW9uIChzZWFyY2hTdHJpbmcpIHtcclxuICAgICAgICAgICAgdmFyIHVybCA9ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3VzZXJzJztcclxuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGFyU2VhcmNoUmVzdWx0cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHJlc3BvbnNlLmRhdGEudXNlcnMudXNlciwgZnVuY3Rpb24gKHNlYXJjaFIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U1IgPSBuZXcgU2VhcmNoUmVzdWx0KHNlYXJjaFIudXNlcm5hbWUsIHNlYXJjaFIucGhvdG9VcmwsIHNlYXJjaFIuZW1haWwsIHNlYXJjaFIuX2lkLiRvaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFyU2VhcmNoUmVzdWx0cy5wdXNoKG5ld1NSKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFyU2VhcmNoUmVzdWx0cztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHNlYXJjaEZyb21JZCA9IGZ1bmN0aW9uIChzZWFyY2hTdHJpbmcpIHtcclxuICAgICAgICAgICAgdmFyIHVybCA9ICcuL3VzZXJzLmpzb24nO1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgdXNlcmZvdW5kO1xyXG4gICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHJlc3BvbnNlLmRhdGEudXNlcnMudXNlciwgZnVuY3Rpb24gKHVzZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5faWQuJG9pZCA9PSBzZWFyY2hTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmZvdW5kID0gbmV3IEdmVXNlcih1c2VyLl9pZC4kb2lkLCB1c2VyLnVzZXJuYW1lLCB1c2VyLnBob3RvVXJsLCB1c2VyLmFnZSwgdXNlci5sYXQsIHVzZXIubG9uKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB1c2VyZm91bmQ7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBnZXRTaGFyZXNCeVVzZXJJZCA9IGZ1bmN0aW9uKHVzZXJpZClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSAnLi9zaGFyZXMuanNvbic7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNoYXJlc2ZvdW5kPVtdO1xyXG4gICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHJlc3BvbnNlLmRhdGEuc2hhcmVzLnNoYXJlLCBmdW5jdGlvbiAoc2hhcmUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2hhcmUudXNlcmlkID09IHVzZXJpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U2hhcmUgPSBuZXcgR0ZTaGFyZShzaGFyZS5faWQuJG9pZCwgc2hhcmUudXNlciwgc2hhcmUudXNlcmlkLCBzaGFyZS50aW1lLiRkYXRlLCBzaGFyZS5tb29kLCBzaGFyZS5sYXQsIHNoYXJlLmxuZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlc2ZvdW5kLnB1c2gobmV3U2hhcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNoYXJlc2ZvdW5kO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBzZWFyY2g6IHNlYXJjaCxcclxuICAgICAgICAgICAgc2VhcmNoRnJvbUlkOiBzZWFyY2hGcm9tSWQsXHJcbiAgICAgICAgICAgIGdldFNoYXJlc0J5VXNlcklkOmdldFNoYXJlc0J5VXNlcklkXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJzZWFyY2hTZXJ2aWNlXCIsIFtcIiRodHRwXCIsIHNlYXJjaFNlcnZpY2VdKTtcclxufSkoKTsiLCJmdW5jdGlvbiBHRlNoYXJlKGlkLCB1c2VyLCB1c2VyaWQsIHRpbWUsIG1vb2QsIGxhdCwgbG5nKSB7XHJcbiAgICB0aGlzLmlkID0gaWQ7XHJcbiAgICB0aGlzLnVzZXIgPSB1c2VyO1xyXG4gICAgdGhpcy51c2VyaWQgPSB1c2VyaWQ7XHJcbiAgICB0aGlzLnRpbWUgPSB0aW1lO1xyXG4gICAgdGhpcy5tb29kID0gbW9vZDtcclxuICAgIHRoaXMubGF0ID0gbGF0O1xyXG4gICAgdGhpcy5sbmcgPSBsbmc7XHJcbn1cclxuR0ZTaGFyZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VyICsgXCIgKFwiICsgdGhpcy50aW1lICsgXCIpXCI7XHJcbn07XHJcbiIsImZ1bmN0aW9uIEdmVXNlcihpZCwgdXNlcm5hbWUsIHBob3RvVXJsLCBhZ2UsIGxhdCwgbG9uKSB7XHJcbiAgICB0aGlzLmlkID0gaWQ7XHJcbiAgICB0aGlzLnVzZXJuYW1lID0gdXNlcm5hbWU7XHJcbiAgICB0aGlzLnBob3RvVXJsID0gcGhvdG9Vcmw7XHJcbiAgICB0aGlzLmFnZSA9IGFnZTtcclxuICAgIHRoaXMubGF0ID0gbGF0O1xyXG4gICAgdGhpcy5sb24gPSBsb247XHJcbn1cclxuR2ZVc2VyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLnVzZXJuYW1lO1xyXG59O1xyXG5cclxuR2ZVc2VyLnByb3RvdHlwZS5hZ2Vub3cgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgYmlydGhkYXkgPSBuZXcgRGF0ZSh0aGlzLmFnZS5kYXRlKTtcclxuICAgIHZhciBhZ2UgPSBEYXRlLm5vdygpIC0gYmlydGhkYXk7XHJcbiAgICBjb25zb2xlLmxvZyhhZ2UpO1xyXG59O1xyXG4iLCJmdW5jdGlvbiBTZWFyY2hSZXN1bHQodGl0bGUsIHBob3RvVXJsLCBkZXNjcmlwdGlvbiwgaWQpXHJcbntcclxuICAgIHRoaXMudGl0bGUgPSB0aXRsZTtcclxuICAgIHRoaXMucGhvdG9VcmwgPSBwaG90b1VybDtcclxuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxufVxyXG5TZWFyY2hSZXN1bHQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy50aXRsZTtcclxufTtcclxuIiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyMi8xMS8yMDE1LlxyXG4gKi9cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
