(function () {
    "use strict";

    var app = angular.module("geofeelings", ["ngRoute"]);

    app.config(function ($routeProvider) {
        $routeProvider
            .when("/admin", {
                templateUrl: "./controllers/adminController/admin.html"
            }).when("/search", {
                templateUrl: "./controllers/searchController/search.html"
            }).when("/intro", {
                templateUrl: "./controllers/introController/intro.html"
            }).when("/help", {
                templateUrl: "./directives/help.html"
            }).when("/login", {
                templateUrl: "./controllers/loginController/login.html"
            }).when("/register", {
                templateUrl: "./controllers/loginController/register.html"
            }).when("/password", {
                templateUrl: "./controllers/loginController/password.html"
            }).when("/user", {
                templateUrl: "./controllers/userController/user.html"
            }).when("/user/:param", {
                templateUrl: "./controllers/userController/user.html",
                controller: 'userController'
            }).when("/me", {
                templateUrl: "./controllers/userController/me.html"
            }).when("/event", {
                templateUrl: "./controllers/eventController/event.html"
            }).when("/event/:param", {
                templateUrl: "./controllers/eventController/event.html",
            }).when("/addEvent", {
                templateUrl: "./controllers/eventController/addEvent.html"
            }).when("/intro_shared", {
                templateUrl: "./controllers/introController/intro_shared.html"
            }).otherwise({
                redirectTo: "/intro"
            });
    });

    app.directive("searchresult", function () {
        return {
            restrict: 'E',
            templateUrl: 'directives/searchResult.html'
        };
    });

    app.service('sharedProperties', function () {
        var property = 'First';

        return {
            getProperty: function () {
                return property;
            },
            setProperty: function (value) {
                property = value;
            }
        };
    });

})();

/**
 * Created by Jonatan on 6/12/2015.
 */

(function () {
    "use strict";

    var adminController = function ($scope) {

    };

    angular.module("geofeelings").controller("adminController", ["$scope", adminController]);
})();
/**
 * Created by Jonatan on 30/12/2015.
 */

(function () {
    "use strict";

    var addEventController = function ($scope, $location, eventService, profileService) {
        $scope.newEvent = {};

        profileService.getUser(function(err, user) {
            if(!err) {
                if(user.redirect) {
                    $location.path(user.redirect);
                } else {
                    $scope.newEvent.authorid = user.id;
                }
            } else {
                console.log("> error in userService: " + err);
            }
        });

        $scope.createEvent = function() {
            $scope.newEvent.address = makeAddress($scope.newEvent.address1, $scope.newEvent.address2);
            eventService.postEvent($scope.newEvent, function (err, data) {
                if(!err) {
                    $location.path("/event/" + data.event._id);
                } else {
                    console.log("> error in eventService: " + err);
                }
            });
        };

        var makeAddress = function (address1, address2) {
            return address1 + "," + address2;
        };
    };

    angular.module("geofeelings").controller("addEventController", ["$scope", "$location", "eventService", "profileService", addEventController]);
})();
/**
 * Created by Jonatan on 4/12/2015.
 */


(function () {
    "use strict";

    var eventController = function ($scope, $location, $sce, $routeParams, eventService, shareService, profileService) {
        var eventid = $routeParams.param;
        $scope.newEvent = {};

        eventService.getEventById(eventid, function(err, event) {
            if(!err) {
                $scope.event = event;
                $scope.event.mood = 50;
                $scope.event.eventid = event.id;
                $scope.event.address1 = splitAddress($scope.event.address, 0);
                $scope.event.address2 = splitAddress($scope.event.address, 1);

                if(!$scope.event.eventimage) {
                    $scope.event.eventimage = "http://student.howest.be/jonatan.michiels/geofeelings/assets/event.png";
                }

                if($scope.event.authorid) {
                    profileService.getUser(function(err, user) {
                        if(!err) {
                            $scope.event.userid = user.id;

                            if(user.redirect) {
                                $location.path(user.redirect);
                            } else {
                                return $scope.event.authorid === user.id;
                            }
                        } else {
                            console.log("> error in userService: " + err);
                        }
                    });
                } else {
                    $scope.event.isAuthor = false;
                }

                shareService.getSharesByEventId(event.id, function(err, shares) {
                    if(!err) {
                        if(shares.redirect) {
                            $location.path(shares.redirect);
                        } else {
                            if(shares.length > 0) {
                                $scope.sharesforevent = shares;
                            } else {
                                $scope.noShares = "<div>No shares for this event.</div>";
                            }
                        }
                    } else {
                        console.log("> error in shareService: " + err);
                    }
                });
            } else {
                console.log("> error in eventService: " + err);
            }
        });

        $scope.renderHtml = function(html) {
            return $sce.trustAsHtml(html);
        };

        $scope.postShare = function() {
            $scope.event.time = new Date();
            shareService.postShareAsync($scope.event, function(err, data) {
                if(!err) {
                    if(data.redirect) {
                        $location.path(data.redirect);
                    } else {
                        $scope.event = data;
                    }
                } else {
                    console.log("> error in shareService: " + err);
                }
            });
        };

        $scope.updateEvent = function() {
            $scope.event.address = makeAddress($scope.event.address1, $scope.event.address2);
            eventService.updateEvent($scope.event, function(err, data) {
                if(!err) {
                    if(data.redirect) {
                        $location.path(data.redirect);
                    } else {
                        $scope.event = data;
                        $scope.event.address1 = splitAddress($scope.event.address, 0);
                        $scope.event.address2 = splitAddress($scope.event.address, 1);
                    }
                } else {
                    console.log("> error in eventService: " + err);
                }
            });
        };

        $scope.createEvent = function() {
            $scope.newEvent.address = makeAddress($scope.newEvent.address1, $scope.newEvent.address2);
            $scope.newEvent.authorid = $scope.event.userid;
            eventService.postEvent($scope.newEvent, function (err, data) {
                if(!err) {
                    $scope.event = data;
                    $location.path("/event/" + data.id);
                } else {
                    console.log("> error in eventService: " + err);
                }
            });
        };

        var splitAddress = function (address, part) {
            var split = address.split(",");
            return split[part];
        };

        var makeAddress = function (address1, address2) {
            return address1 + "," + address2;
        };
    };

    angular.module("geofeelings").controller("eventController", ["$scope", "$location", "$sce", "$routeParams", "eventService", "shareService", "profileService", eventController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var introController = function ($scope, shareService, $http, $location, profileService,shareVarsBetweenCtrl) {


        //SMILEY TEKENEN
        $scope.sliderValue = 50;
        $scope.moodWord = null;
        var c = document.getElementById("smileyCanvas");
        var ctx = c.getContext("2d");

        var sadRGB = [152, 30, 30];
        var happyRGB = [70, 161, 73];

        //telkens slidervalue verandert gezichtje tekenen
        $scope.$watch("sliderValue", function () {
            ctx.clearRect(0, 0, c.width, c.height); //canvas clearen voor nieuw frame

            var mood = $scope.sliderValue;
            giveMoodWord();
            //offset positie mond
            var offsetX = c.width / 5;
            var offSetY = c.width / 2.14 + (mood / (c.width / 6));

            //variabelen voor beziercurve (= mond)
            var SPx = offsetX;
            var SPy = offSetY + c.width / 3 - (mood * (c.width / 376.66));
            var H1x = offsetX;
            var H1y = offSetY + (mood * (c.width / 250));
            var H2x = offsetX + ((c.width / 300) * 180);
            var H2y = offSetY + (mood * (c.width / 250));
            var EPx = offsetX + (c.width / 1.666);
            var EPy = offSetY + (c.width / 3) - (mood * (c.width / 376.66));

            //hoofd
            ctx.lineWidth = c.width / 60;
            ctx.beginPath();
            ctx.arc((c.width / 2), (c.width / 2), (c.width / 2.07), 0, 2 * Math.PI);
            ctx.fillStyle = "rgb(" + moodColor(0) + "," + moodColor(1) + "," + moodColor(2) + ")";
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.stroke();

            //mond

            ctx.lineWidth = c.width / 30;
            ctx.beginPath();
            ctx.moveTo(SPx, SPy);
            ctx.bezierCurveTo(H1x, H1y, H2x, H2y, EPx, EPy);
            ctx.strokeStyle = 'black';
            ctx.stroke();
            ctx.lineCap = "round";

            //oog links

            ctx.lineWidth = c.width / 60;
            ctx.beginPath();
            ctx.arc(c.width / 3, c.width / 3, c.width / 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();

            //oog rechts
            ctx.beginPath();
            ctx.arc(c.width / 3 * 2, c.width / 3, c.width / 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();
        });

        var moodColor = function (c) {
            //c: R = 0, G = 1, B = 2

            if (sadRGB[c] > happyRGB[c]) {
                return Math.round(sadRGB[c] - ((sadRGB[c] - happyRGB[c]) * ($scope.sliderValue / 100)));
            }
            else {
                return Math.round(sadRGB[c] + ((happyRGB[c] - sadRGB[c]) * ($scope.sliderValue / 100)));
            }

        };

        var moodwords = ["horrible", "really bad", "bad", "okay", "good", "really good", "excellent"];

        var giveMoodWord = function () {
            if ($scope.sliderValue < 5) {
                $scope.moodWord = moodwords[0];
            }
            else if ($scope.sliderValue < 25) {
                $scope.moodWord = moodwords[1];
            }
            else if ($scope.sliderValue < 40) {
                $scope.moodWord = moodwords[2];
            }
            else if ($scope.sliderValue < 60) {
                $scope.moodWord = moodwords[3];
            }
            else if ($scope.sliderValue < 75) {
                $scope.moodWord = moodwords[4];
            }
            else if ($scope.sliderValue < 95) {
                $scope.moodWord = moodwords[5];
            }
            else {
                $scope.moodWord = moodwords[6];
            }
        };

        $http.get('/auth/user').success(function (data) {
            $scope.user = data;
        });
        $scope.sharePosted = false;
        $scope.postShare = function () {
            $scope.sharePosted = true;
            profileService.getUser(function (err, data) {
                if (!err) {
                    if (data.redirect) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var userlessShareData = {
                                "userid": 0,
                                "eventid": null,
                                "time": new Date().toISOString(),
                                "mood": $scope.sliderValue,
                                "lat": position.coords.latitude,
                                "lng": position.coords.longitude
                            };

                            shareVarsBetweenCtrl.saveUserlessShare(userlessShareData);
                        });
                        $location.path(data.redirect);

                    } else {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var data = {
                                "userid": $scope.user._id,
                                "eventid": null,
                                "time": new Date().toISOString(),
                                "mood": $scope.sliderValue,
                                "lat": position.coords.latitude,
                                "lng": position.coords.longitude
                            };
                            shareService.postShare(data);
                        });
                    }
                } else {
                    console.log("error: " + err);
                }
            });
        };
    };

    angular.module("geofeelings").controller("introController", ["$scope", "shareService", "$http", "$location", "profileService","shareVarsBetweenCtrl", introController]);
})();
/**
 * Created by Lienert on 21/12/2015.
 */

(function () {
    "use strict";

    var intro_sharedController = function ($scope, shareVarsBetweenCtrl,profileService) {
        $scope.infoPostedShare = shareVarsBetweenCtrl.getProperty().share;
    };
    angular.module("geofeelings").controller("intro_sharedController", ["$scope", "shareVarsBetweenCtrl","profileService", intro_sharedController]);
})();
/**
 * Created by Jonatan on 26/11/2015.
 */

(function () {
    "use strict";

    var loginController = function ($scope, $http, $location, shareVarsBetweenCtrl, shareService, profileService) {

        var postUserlessShare = function(){
            var shareData = shareVarsBetweenCtrl.returnUserlessShare();
            profileService.getUser(function (err, user) {
                if (!err) {
                    if (user.redirect) {
                        $location.path(user.redirect);
                    } else {
                        shareData.userid = user.id;
                        shareService.postShare(shareData); //post de share met de inlogdata dat hij nu weet
                        shareVarsBetweenCtrl.saveUserlessShare("");
                    }
                } else {
                    console.log("> error profileService: " + err);
                }
            });
        };

        $scope.login = function () {
            $http.post('http://localhost:3000/auth/login', {
                username: $scope.username,
                password: $scope.password
            }).success(function (data) {
                $scope.error = data.error;
                if (shareVarsBetweenCtrl.returnUserlessShare() !== undefined && shareVarsBetweenCtrl.returnUserlessShare() !== "") //user heeft willen sharen, maar was niet ingelogd.
                {
                    postUserlessShare();
                }
                else {
                    $location.path(data.redirect);
                }
            });
        };

        $scope.register = function () {
            $http.post('http://localhost:3000/auth/register', {
                username: $scope.username,
                password: $scope.password,
                email: $scope.email
            }).success(function (data) {
                $scope.error = data.error;
                if (shareVarsBetweenCtrl.returnUserlessShare() !== undefined && shareVarsBetweenCtrl.returnUserlessShare() !== "") //user heeft willen sharen, maar was niet ingelogd.
                {
                    postUserlessShare();
                }
                else {
                    $location.path(data.redirect);
                }
            });
        };
    };

    angular.module("geofeelings").controller("loginController", ["$scope", "$http", "$location", "shareVarsBetweenCtrl", "shareService", "profileService", loginController]);
})();
/**
 * Created by Jonatan on 21/11/2015.
 */

(function () {
    "use strict";

    var mainController = function ($scope, googleMapsService, shareService, eventService) {
        shareService.getAllShares(function (err, shares) {
            if (!err) {
                googleMapsService.showLocationOnMap();
                googleMapsService.showAllMarkers(shares);
                $scope.shares = shares;
                $scope.timelapse = 100;
                $scope.timestamp = "All time";
            } else {
                console.log("> error in shareService: " + err);
            }
        });

        $scope.$watch("timelapse", function() {
            if($scope.timelapse >= 80) {
                $scope.timestamp = "All time";
                googleMapsService.showAllMarkers($scope.shares);
            } else if($scope.timelapse >= 60 && $scope.timelapse < 80) {
                $scope.timestamp = "Last year";
                googleMapsService.showAllMarkers(filterSharesOnTime(new Date(1, 0, 0, 0, 0, 0, 0)));
            } else if($scope.timelapse >= 40 && $scope.timelapse < 60) {
                $scope.timestamp = "Last month";
                googleMapsService.showAllMarkers(filterSharesOnTime(new Date(0, 1, 0, 0, 0, 0, 0)));
            } else if($scope.timelapse >= 20 && $scope.timelapse < 40) {
                $scope.timestamp = "Last week";
                googleMapsService.showAllMarkers(filterSharesOnTime(new Date(0, 0, 7, 0, 0, 0, 0)));
            } else if($scope.timelapse > 0 && $scope.timelapse < 20) {
                $scope.timestamp = "Last day";
                googleMapsService.showAllMarkers(filterSharesOnTime(new Date(0, 0, 1, 0, 0, 0, 0)));
            } else {
                $scope.timestamp = "last hour";
                googleMapsService.showAllMarkers(filterSharesOnTime(new Date(0, 0, 0, 1, 0, 0, 0)));
            }
        });

        var filterSharesOnTime = function(timeago) {
            var shares = [];
            angular.forEach($scope.shares, function(share) {
                if(timeago <= (new Date() - share.time)) {
                    shares.push(share);
                }
            });
            return shares;
        }
    };

    angular.module("geofeelings").controller("mainController", ["$scope", "googleMapsService", "shareService", "eventService", mainController]);
})();
/**
 * Created by Jonatan on 25/11/2015.
 */


(function () {
    "use strict";

    var searchController = function ($scope, searchService, sharedProperties) {

        $scope.searchModel = null;

        $scope.searchOnSubmit = function (formObj) {
            if ($scope.searchModel.length > 0) {
                searchNow();
            }
        };
        $scope.searchOnKeyPress = function () {
            if ($scope.searchModel !== null) {
                searchNow();
            }
        };

        $scope.filterSearchResults = function (i) {
            if ($scope.searchModel === "") {
                return false;
            }

            if (i.username.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                return true;
            }
            if (i.description !== undefined) {
                if (i.description.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                    return true;
                }
            }

            return false;
        };


        var searchNow = function () {
            searchService.search($scope.searchModel).then(onResultsReady);
        };

        var onResultsReady = function (res) {
            $scope.searchResults = res;
        };

        var onResultsError = function (err) {
        };
    };

    angular.module("geofeelings").controller("searchController", ["$scope", "searchService","sharedProperties", searchController]);
})();
/**
 * Created by Jonatan on 21/12/2015.
 */

(function () {
    "use strict";

    var meController = function ($scope, $http, $location, profileService, shareService, eventService) {
        profileService.getUser(function (err, user) {
            if (!err) {
                if (user.redirect) {
                    $location.path(user.redirect);
                } else {
                    $scope.user = user;
                    $scope.user.address1 = splitAddress(user.address, 0);
                    $scope.user.address2 = splitAddress(user.address, 1);

                    shareService.getSharesByUserId(user.id, function (err, shares) {
                        if(!err) {
                            if(shares.redirect) {
                                $location.path(shares.redirect);
                            } else {
                                angular.forEach(shares, function(share){
                                    if(share.eventid) {
                                        eventService.getEventById(share.eventid, function (err, event) {
                                            if(!err) {
                                                share.address = event.eventname;
                                            } else {
                                                console.log("> error eventService: " + err);
                                            }
                                        });
                                    }
                                });

                                $scope.sharesforprofile = shares;
                            }
                        } else {
                            console.log("> error shareService: " + err);
                        }
                    });
                }
            } else {
                console.log("> error profileService: " + err);
            }
        });

        $scope.save = function (user) {
            user.address = makeAddress(user.address1, user.address2);
            profileService.saveUser(user, function(err, data) {
                if(!err) {
                    if (data.redirect) {
                        $location.path(data.redirect);
                    } else {
                        $scope.user = data;
                        $scope.user.address1 = splitAddress(data.address, 0);
                        $scope.user.address2 = splitAddress(data.address, 1);
                    }
                } else {
                    console.log("> error: " + err);
                }
            });
        };

        $scope.logout = function () {
            profileService.logout().then(function (data) {
                $location.path(data);
            });
        };

        var splitAddress = function (address, part) {
            var split = address.split(",");
            return split[part];
        };

        var makeAddress = function (address1, address2) {
            return address1 + "," + address2;
        };
    };

    angular.module("geofeelings").controller("meController", ["$scope", "$http", "$location", "profileService", "shareService", "eventService", meController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var userController = function ($scope, $location, searchService, shareService, $routeParams) {

        $scope.init = function () {
            var userid = $routeParams.param;
            searchService.searchUserFromId(userid).then(userFoundWithId);

            shareService.getSharesByUserId(userid, function (err, shares) {
                if (!err) {
                    $scope.shareFoundWithUserId = shares;
                    var feelingImages = ["depressed", "sad", "common", "happy", "excited"];
                    angular.forEach(shares, function (share) {
                        share.moodImageSource = "./assets/" + feelingImages[giveFeelingsImageArrayNumber(share)] + ".png";
                        $scope.marker = new google.maps.Marker({
                            position: {lat: share.lat, lng: share.lng},
                            map: $scope.map,
                            icon: share.moodImageSource
                        });
                    });
                } else {
                    console.log("> error in shareService: " + err);
                }
            });
        };

        var userFoundWithId = function (res) {
            $scope.userfoundwithid = res;

            if (res.lat !== undefined && res.lat !== undefined) {
                $scope.map.setCenter(new google.maps.LatLng(res.lat, res.lng));
                if ($scope.marker !== undefined) {
                    $scope.marker.setMap(null); //verwijdert alle markers eerst
                }
                $scope.marker = new google.maps.Marker({
                    position: {lat: res.lat, lng: res.lng},
                    map: $scope.map,
                    icon: $scope.image
                });
            }
        };

        var giveFeelingsImageArrayNumber = function (share) {
            if (share.mood > 80) {
                return 4;
            }
            else {
                return Math.round(share.mood / 20);
            }
        };
    };

    angular.module("geofeelings").controller("userController", ["$scope", "$location", "searchService", "shareService", "$routeParams", userController]);
})
();
/**
 * Created by Jonatan on 28/12/2015.
 */

var eventService = function ($http, googleMapsService) {
    "use strict";

    //private

    //public
    return {
        getEventById : function (eventid, cb) {
            $http.get("/api/event/" + eventid).success(function (data) {
                if(data.redirect) {
                    cb(null, data);
                } else {
                    if(data.address) {
                        cb(null, new GfEvent(data._id, data.eventname, data.eventimage, data.authorid, new Date (data.from), new Date(data.until), data.lat, data.lng, data.address));
                    } else {
                        googleMapsService.convertCoordinatesToAdress(data.lat, data.lng, function(err, address) {
                            if(!err) {
                                cb(null, cb(null, new GfEvent(data._id, data.eventname, data.eventimage, data.authorid, new Date(data.from), new Date(data.until), data.lat, data.lng, address)));
                            } else {
                                cb(err, null);
                            }
                        });
                    }
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        postEvent : function(data, cb) {
            googleMapsService.convertAdressToCoordinates(data.address, function(err, coord) {
                if(!err) {
                    data.lat = coord.lat();
                    data.lng = coord.lng();

                    $http.post("/api/event", new GfEvent(data._id, data.eventname, data.eventimage, data.authorid, new Date(data.from), new Date(data.until), data.lat, data.lng, data.address)).success(function(response) {
                        cb(null, response)
                    }).error(function(error) {
                        cb(error, null);
                    });
                } else {
                    cb(err, null);
                }
            });
        },

        updateEvent : function(data, cb) {
            googleMapsService.convertAdressToCoordinates(data.address, function (err, coord) {
                if(!err) {
                    data.lat = coord.lat();
                    data.lng = coord.lng();

                    $http.put("/api/event/" + data.id, data).success(function (response) {
                        cb(null, new GfEvent(response._id, response.eventname, response.eventimage, response.authorid, new Date(response.from), new Date(response.until), response.lat, response.lng, response.address));
                    }).error(function (error) {
                        cb(error, null);
                    });
                } else {
                    cb(err, null);
                }
            });
        }
    };
};

angular.module("geofeelings").factory("eventService", ["$http", "googleMapsService", eventService]);
/**
 * Created by Jonatan on 22/12/2015.
 */

// https://developers.google.com/maps/documentation/geocoding/intro?csw=1#Geocoding
// Dit gebruiken om adressen te vertalen naar lat en lng of omgekeerd
// Waarom? => google maps werkt met lat en lng, wordt zo opgeslaan in de database

var googleMapsService = function () {
    "use strict";
    // private
    var mapoptions = {
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        disableDefaultUI: true
    };
    var geocoder = new google.maps.Geocoder();
    var map = new google.maps.Map(document.querySelector("#map"), mapoptions);

    var chooseIcon = function(mood) {
        var url = "http://student.howest.be/jonatan.michiels/geofeelings/assets/";
        if(mood <= 20) {
            return url += "depressed.png";
        } else if(mood > 20 && mood <= 40) {
            return url += "sad.png";
        } else if(mood > 40 && mood <= 60) {
            return url += "common.png";
        } else if(mood > 60 && mood <= 80) {
            return url += "happy.png";
        } else {
            return url += "excited.png";
        }
    };

    //public
    return {
        showLocationOnMap: function () {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                    var marker = new google.maps.Marker({
                        position: map.getCenter(),
                        map: map,
                        icon: "http://student.howest.be/jonatan.michiels/geofeelings/assets/location_now.png"
                    });
                });
            } else {
                // Throw map exception
            }
        },

        showAllMarkers: function (data) {
            var marker, i;
            for(i = 0; i < data.length; i++) {
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(data[i].lat, data[i].lng),
                    map: map,
                    icon: chooseIcon(data[i].mood)
                });

                var infoWindow = new google.maps.InfoWindow();
                var content = "<h4 class='infowindowstyle'> Share details </h4>" + "<p class='infowindowstyle'> Mood: <span>" + data[i].mood + "%</span></p>" + "<p class='infowindowstyle'> Time: <span>" + new Date(data[i].time) + "</span></p>" + "<p class='infowindowstyle'> Address: <span>" + data[i].address + "</span></p>" + "<p class='infowindowstyle'> Event: <span>"+ data[i].eventid + "</span></p>";

                google.maps.event.addListener(marker, "click", (function (marker, content, infoWindow) {
                    return function () {
                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);
                    };
                })(marker, content, infoWindow));
            }
        },

        convertAdressToCoordinates: function (address, cb) {
            geocoder.geocode({address: address}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    cb(null, results[0].geometry.location);
                } else {
                    cb(status, null);
                }
            });
        },

        convertCoordinatesToAdress: function (lat, lng, cb) {
            var location = new google.maps.LatLng(lat, lng);
            geocoder.geocode({latLng: location}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    cb(null, results[0].formatted_address);
                } else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                    setTimeout(function(){
                        cb(null, results[0].formatted_address);
                    }, 200);
                } else {
                    cb(status, null);
                }
            });
        }
    };
};

angular.module("geofeelings").factory("googleMapsService", [googleMapsService]);
/**
 * Created by Jonatan on 27/12/2015.
 */

var profileService = function ($http, googleMapsService) {
    "use strict";

    // private

    //public
    return {
        getUser : function (cb) {
            $http.get("/auth/user").success(function (data) {
                if(data.redirect) {
                    cb(null, data);
                } else {
                    cb(null, new GfUser(data._id, data.username, data.email, data.userimage, new Date(data.age), data.lat, data.lng, data.address, data.chat, data.admin));
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        saveUser : function (user, cb) {
            googleMapsService.convertAdressToCoordinates(user.address, function(err, coord) {
                if(!err) {
                    user.lat = coord.lat();
                    user.lng = coord.lng();

                    $http.put("/api/user/" + user.id, user).success(function (data) {
                        if(data.redirect) {
                            cb(null, data);
                        } else {
                            cb(null, new GfUser(data._id, data.username, data.email, data.userimage, new Date(data.age), data.lat, data.lng, data.address, data.chat, data.admin));
                        }
                    }).error(function (error) {
                        cb(error, null);
                    });
                } else {
                    cb(err, null);
                }
            });
        },

        logout : function () {
            return $http.get("/auth/logout").then(function (data) {
                return data;
            });
        }
    };
};

angular.module("geofeelings").factory("profileService", ["$http", "googleMapsService", profileService]);
(function () {
    "use strict";

    var searchService = function ($http) {

        var search = function (searchString) {
            var url = 'http://localhost:3000/api/user/';

            return $http.get(url).then(function (response) {

                var arSearchResults = [];
                angular.forEach(response.data, function (searchR) {
                    var newSR = new SearchResult(searchR._id, searchR.username);
                    arSearchResults.push(newSR);
                });
                return arSearchResults;
            });
        };

        var searchUserFromId = function (searchString) {
            var url = 'http://localhost:3000/api/user/' + searchString;
            return $http.get(url).then(function (response) {
                return new GfUser(
                    response.data._id,
                    response.data.username,
                    response.data.email,
                    response.data.userimage,
                    response.data.age,
                    response.data.lat,
                    response.data.lng,
                    response.data.chat,
                    response.data.admin
                );

            });
        };

        return {
            search: search,
            searchUserFromId: searchUserFromId
        };
    };
    angular.module("geofeelings").factory("searchService", ["$http", searchService]);
})();
/**
 * Created by Lienert on 23/12/2015.
 */

/**
 * OPMERKING VOOR LIENERT!!!!
 * post share zal niet werken
 * implementeer googleService
 * voorbeeld kan je vinden in profileservice (put functie)
 * Groetjes Jonatan
 */


var shareService = function ($http, $location, googleMapsService, shareVarsBetweenCtrl) {
    "use strict";

    //private
    var makeAddress = function (address) {
        if(address) {
            var split = address.split(",");
            return split[0] + ", " + split[1];
        } else {
            return null;
        }
    };

    var postShare = function (data) {
        $http({
            url: 'http://localhost:3000/api/share',
            method: 'POST',
            data: data
        }).success(function (serverData) {
            shareVarsBetweenCtrl.setProperty(serverData); //data kunnen doorgeven aan intro_sharedController
            $location.path("intro_shared");
        });
    };

    //public
    return {
        postShare: postShare,
        postShareAsync: function (data, cb) {
            if(data.address) {
                $http.post("/api/share", data).success(function(response) {
                    if(response.redirect) {
                        cb(null, response);
                    } else {
                        cb(null, new GfShare(data._id, data.userid, data.eventid, data.time, data.mood, data.lat, data.lng, makeAddress(data.address)));
                    }
                }).error(function (error) {
                    cb(error, null);
                });
            } else {
                googleMapsService.convertCoordinatesToAdress(data.lat, data.lng, function(err, address) {
                    if(!err) {
                        $http.post("/api/share", data).success(function(response) {
                            if(response.redirect) {
                                cb(null, response);
                            } else {
                                cb(null, new GfShare(data._id, data.userid, data.eventid, data.time, data.mood, data.lat, data.lng, makeAddress(address)));
                            }
                        }).error(function (error) {
                            cb(error, null);
                        });
                    } else {
                        cb(err, null);
                    }
                });
            }
        },

        getSharesByUserId: function (userid, cb) {
            $http.get("/api/share/user/" + userid).success(function (data) {
                if(data.redirect) {
                    cb(null, data);
                } else {
                    var shares = [];
                    angular.forEach(data, function(share) {
                        shares.push(new GfShare(share._id, share.userid, share.eventid, share.time, share.mood, share.lat, share.lng, makeAddress(share.address)));
                    });
                    cb(null, shares);
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getSharesByEventId: function (eventid, cb) {
            $http.get("/api/share/event/" + eventid).success(function (data) {
                if(data.redirect) {
                    cb(null, data);
                } else {
                    var shares = [];
                    angular.forEach(data, function(share) {
                        shares.push(new GfShare(share._id, share.userid, share.eventid, share.time, share.mood, share.lat, share.lng, makeAddress(share.address)));
                    });
                    cb(null, shares);
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getAllShares: function (cb) {
            $http.get("/api/share").success(function (data) {
                var shares = [];
                angular.forEach(data, function(share) {
                    shares.push(new GfShare(share._id, share.userid, share.eventid, share.time, share.mood, share.lat, share.lng, makeAddress(share.address)));
                });
                cb(null, shares);
            }).error(function(error) {
                cb(error, null);
            });
        }
    };
};
angular.module("geofeelings").factory("shareService", ["$http", "$location", "googleMapsService", "shareVarsBetweenCtrl", shareService]);

/**
 * Created by liene on 28/12/2015.
 */


var shareVarsBetweenCtrl = function () {
    "use strict";

    //private
    var property;
    var userlessShare;

    //public
    return {

        getProperty: function () {
            return property;
        },

        setProperty: function (value) {
            property = value;
        },

        saveUserlessShare: function (data) {
            userlessShare = data;
        },
        returnUserlessShare: function () {
            return userlessShare;
        }
    };
};

angular.module("geofeelings").factory("shareVarsBetweenCtrl", [shareVarsBetweenCtrl]);
/**
 * Created by Jonatan on 28/12/2015.
 */

function GfEvent(id, eventname, eventimage, authorid, from, until, lat, lng, address) {
    this.id = id;
    this.eventname = eventname;
    this.eventimage = eventimage;
    this.authorid = authorid;
    this.from = from;
    this.until = until;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
}

GfShare.prototype.toString = function () {
    return this.eventname;
};
function GfShare(id, userid, eventid, time, mood, lat, lng, address) {
    this.id = id;
    this.userid = userid;
    this.eventid = eventid;
    this.time = time;
    this.mood = mood;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
}

GfShare.prototype.toString = function () {
    return this.userid + " (" + this.time + ")";
};

function GfUser(id, username, email, userimage, age, lat, lng, address, chat, admin) {
    this.id = id;
    this.username = username;
    this.email = email;
    this.userimage = userimage;
    this.age = age;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
    this.chat = chat;
    this.admin = admin;
}

GfUser.prototype.toString = function () {
    return this.username;
};

function SearchResult(id,username)
{
    this.id = id;
    this.username = username;
}
SearchResult.prototype.toString = function() {
    return this.title;
};

/**
 * Created by Jonatan on 22/11/2015.
 */

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImFkbWluQ29udHJvbGxlci9hZG1pbkNvbnRyb2xsZXIuanMiLCJldmVudENvbnRyb2xsZXIvYWRkRXZlbnRDb250cm9sbGVyLmpzIiwiZXZlbnRDb250cm9sbGVyL2V2ZW50Q29udHJvbGxlci5qcyIsImludHJvQ29udHJvbGxlci9pbnRyb0NvbnRyb2xsZXIuanMiLCJpbnRyb0NvbnRyb2xsZXIvaW50cm9fc2hhcmVkQ29udHJvbGxlci5qcyIsImxvZ2luQ29udHJvbGxlci9sb2dpbkNvbnRyb2xsZXIuanMiLCJtYWluQ29udHJvbGxlci9tYWluQ29udHJvbGxlci5qcyIsInNlYXJjaENvbnRyb2xsZXIvc2VhcmNoQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyL21lQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyL3VzZXJDb250cm9sbGVyLmpzIiwiZXZlbnRTZXJ2aWNlLmpzIiwiZ29vZ2xlTWFwc1NlcnZpY2UuanMiLCJwcm9maWxlU2VydmljZS5qcyIsInNlYXJjaFNlcnZpY2UuanMiLCJzaGFyZVNlcnZpY2UuanMiLCJzaGFyZVZhcnNCZXR3ZWVuQ3RybHMuanMiLCJnZkV2ZW50LmpzIiwiZ2ZTaGFyZS5qcyIsImdmVXNlci5qcyIsIlNlYXJjaFJlc3VsdC5qcyIsIm1hcEV4Y2VwdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNaQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDN0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0NBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNSQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIsIFtcIm5nUm91dGVcIl0pO1xyXG5cclxuICAgIGFwcC5jb25maWcoZnVuY3Rpb24gKCRyb3V0ZVByb3ZpZGVyKSB7XHJcbiAgICAgICAgJHJvdXRlUHJvdmlkZXJcclxuICAgICAgICAgICAgLndoZW4oXCIvYWRtaW5cIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9hZG1pbkNvbnRyb2xsZXIvYWRtaW4uaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvc2VhcmNoXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvc2VhcmNoQ29udHJvbGxlci9zZWFyY2guaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvaW50cm9cIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9pbnRyb0NvbnRyb2xsZXIvaW50cm8uaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvaGVscFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2RpcmVjdGl2ZXMvaGVscC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9sb2dpblwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2xvZ2luQ29udHJvbGxlci9sb2dpbi5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9yZWdpc3RlclwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2xvZ2luQ29udHJvbGxlci9yZWdpc3Rlci5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9wYXNzd29yZFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2xvZ2luQ29udHJvbGxlci9wYXNzd29yZC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi91c2VyXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvdXNlckNvbnRyb2xsZXIvdXNlci5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi91c2VyLzpwYXJhbVwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL3VzZXJDb250cm9sbGVyL3VzZXIuaHRtbFwiLFxyXG4gICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ3VzZXJDb250cm9sbGVyJ1xyXG4gICAgICAgICAgICB9KS53aGVuKFwiL21lXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvdXNlckNvbnRyb2xsZXIvbWUuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvZXZlbnRcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9ldmVudENvbnRyb2xsZXIvZXZlbnQuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvZXZlbnQvOnBhcmFtXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvZXZlbnRDb250cm9sbGVyL2V2ZW50Lmh0bWxcIixcclxuICAgICAgICAgICAgfSkud2hlbihcIi9hZGRFdmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2V2ZW50Q29udHJvbGxlci9hZGRFdmVudC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9pbnRyb19zaGFyZWRcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9pbnRyb0NvbnRyb2xsZXIvaW50cm9fc2hhcmVkLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS5vdGhlcndpc2Uoe1xyXG4gICAgICAgICAgICAgICAgcmVkaXJlY3RUbzogXCIvaW50cm9cIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC5kaXJlY3RpdmUoXCJzZWFyY2hyZXN1bHRcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnZGlyZWN0aXZlcy9zZWFyY2hSZXN1bHQuaHRtbCdcclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcblxyXG4gICAgYXBwLnNlcnZpY2UoJ3NoYXJlZFByb3BlcnRpZXMnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHByb3BlcnR5ID0gJ0ZpcnN0JztcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZ2V0UHJvcGVydHk6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2V0UHJvcGVydHk6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgcHJvcGVydHkgPSB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuXHJcbn0pKCk7XHJcbiIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gNi8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgYWRtaW5Db250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiYWRtaW5Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBhZG1pbkNvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDMwLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBhZGRFdmVudENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkbG9jYXRpb24sIGV2ZW50U2VydmljZSwgcHJvZmlsZVNlcnZpY2UpIHtcclxuICAgICAgICAkc2NvcGUubmV3RXZlbnQgPSB7fTtcclxuXHJcbiAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbihlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgaWYodXNlci5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKHVzZXIucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmV3RXZlbnQuYXV0aG9yaWQgPSB1c2VyLmlkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIGluIHVzZXJTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmNyZWF0ZUV2ZW50ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5uZXdFdmVudC5hZGRyZXNzID0gbWFrZUFkZHJlc3MoJHNjb3BlLm5ld0V2ZW50LmFkZHJlc3MxLCAkc2NvcGUubmV3RXZlbnQuYWRkcmVzczIpO1xyXG4gICAgICAgICAgICBldmVudFNlcnZpY2UucG9zdEV2ZW50KCRzY29wZS5uZXdFdmVudCwgZnVuY3Rpb24gKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKFwiL2V2ZW50L1wiICsgZGF0YS5ldmVudC5faWQpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIj4gZXJyb3IgaW4gZXZlbnRTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBtYWtlQWRkcmVzcyA9IGZ1bmN0aW9uIChhZGRyZXNzMSwgYWRkcmVzczIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MxICsgXCIsXCIgKyBhZGRyZXNzMjtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJhZGRFdmVudENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGxvY2F0aW9uXCIsIFwiZXZlbnRTZXJ2aWNlXCIsIFwicHJvZmlsZVNlcnZpY2VcIiwgYWRkRXZlbnRDb250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiA0LzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgZXZlbnRDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgJGxvY2F0aW9uLCAkc2NlLCAkcm91dGVQYXJhbXMsIGV2ZW50U2VydmljZSwgc2hhcmVTZXJ2aWNlLCBwcm9maWxlU2VydmljZSkge1xyXG4gICAgICAgIHZhciBldmVudGlkID0gJHJvdXRlUGFyYW1zLnBhcmFtO1xyXG4gICAgICAgICRzY29wZS5uZXdFdmVudCA9IHt9O1xyXG5cclxuICAgICAgICBldmVudFNlcnZpY2UuZ2V0RXZlbnRCeUlkKGV2ZW50aWQsIGZ1bmN0aW9uKGVyciwgZXZlbnQpIHtcclxuICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50ID0gZXZlbnQ7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQubW9vZCA9IDUwO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmV2ZW50aWQgPSBldmVudC5pZDtcclxuICAgICAgICAgICAgICAgICRzY29wZS5ldmVudC5hZGRyZXNzMSA9IHNwbGl0QWRkcmVzcygkc2NvcGUuZXZlbnQuYWRkcmVzcywgMCk7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQuYWRkcmVzczIgPSBzcGxpdEFkZHJlc3MoJHNjb3BlLmV2ZW50LmFkZHJlc3MsIDEpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmKCEkc2NvcGUuZXZlbnQuZXZlbnRpbWFnZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5ldmVudC5ldmVudGltYWdlID0gXCJodHRwOi8vc3R1ZGVudC5ob3dlc3QuYmUvam9uYXRhbi5taWNoaWVscy9nZW9mZWVsaW5ncy9hc3NldHMvZXZlbnQucG5nXCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYoJHNjb3BlLmV2ZW50LmF1dGhvcmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbihlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LnVzZXJpZCA9IHVzZXIuaWQ7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodXNlci5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKHVzZXIucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLmV2ZW50LmF1dGhvcmlkID09PSB1c2VyLmlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIGluIHVzZXJTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmlzQXV0aG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgc2hhcmVTZXJ2aWNlLmdldFNoYXJlc0J5RXZlbnRJZChldmVudC5pZCwgZnVuY3Rpb24oZXJyLCBzaGFyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNoYXJlcy5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoc2hhcmVzLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNoYXJlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNoYXJlc2ZvcmV2ZW50ID0gc2hhcmVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUubm9TaGFyZXMgPSBcIjxkaXY+Tm8gc2hhcmVzIGZvciB0aGlzIGV2ZW50LjwvZGl2PlwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIGluIHNoYXJlU2VydmljZTogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIGluIGV2ZW50U2VydmljZTogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRzY29wZS5yZW5kZXJIdG1sID0gZnVuY3Rpb24oaHRtbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJHNjZS50cnVzdEFzSHRtbChodG1sKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUucG9zdFNoYXJlID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5ldmVudC50aW1lID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgc2hhcmVTZXJ2aWNlLnBvc3RTaGFyZUFzeW5jKCRzY29wZS5ldmVudCwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIGluIHNoYXJlU2VydmljZTogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUudXBkYXRlRXZlbnQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmFkZHJlc3MgPSBtYWtlQWRkcmVzcygkc2NvcGUuZXZlbnQuYWRkcmVzczEsICRzY29wZS5ldmVudC5hZGRyZXNzMik7XHJcbiAgICAgICAgICAgIGV2ZW50U2VydmljZS51cGRhdGVFdmVudCgkc2NvcGUuZXZlbnQsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50ID0gZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmFkZHJlc3MxID0gc3BsaXRBZGRyZXNzKCRzY29wZS5ldmVudC5hZGRyZXNzLCAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmFkZHJlc3MyID0gc3BsaXRBZGRyZXNzKCRzY29wZS5ldmVudC5hZGRyZXNzLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiPiBlcnJvciBpbiBldmVudFNlcnZpY2U6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmNyZWF0ZUV2ZW50ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5uZXdFdmVudC5hZGRyZXNzID0gbWFrZUFkZHJlc3MoJHNjb3BlLm5ld0V2ZW50LmFkZHJlc3MxLCAkc2NvcGUubmV3RXZlbnQuYWRkcmVzczIpO1xyXG4gICAgICAgICAgICAkc2NvcGUubmV3RXZlbnQuYXV0aG9yaWQgPSAkc2NvcGUuZXZlbnQudXNlcmlkO1xyXG4gICAgICAgICAgICBldmVudFNlcnZpY2UucG9zdEV2ZW50KCRzY29wZS5uZXdFdmVudCwgZnVuY3Rpb24gKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5ldmVudCA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoXCIvZXZlbnQvXCIgKyBkYXRhLmlkKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIGluIGV2ZW50U2VydmljZTogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgc3BsaXRBZGRyZXNzID0gZnVuY3Rpb24gKGFkZHJlc3MsIHBhcnQpIHtcclxuICAgICAgICAgICAgdmFyIHNwbGl0ID0gYWRkcmVzcy5zcGxpdChcIixcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGxpdFtwYXJ0XTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgbWFrZUFkZHJlc3MgPSBmdW5jdGlvbiAoYWRkcmVzczEsIGFkZHJlc3MyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhZGRyZXNzMSArIFwiLFwiICsgYWRkcmVzczI7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiZXZlbnRDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRsb2NhdGlvblwiLCBcIiRzY2VcIiwgXCIkcm91dGVQYXJhbXNcIiwgXCJldmVudFNlcnZpY2VcIiwgXCJzaGFyZVNlcnZpY2VcIiwgXCJwcm9maWxlU2VydmljZVwiLCBldmVudENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDEvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGludHJvQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsIHNoYXJlU2VydmljZSwgJGh0dHAsICRsb2NhdGlvbiwgcHJvZmlsZVNlcnZpY2Usc2hhcmVWYXJzQmV0d2VlbkN0cmwpIHtcclxuXHJcblxyXG4gICAgICAgIC8vU01JTEVZIFRFS0VORU5cclxuICAgICAgICAkc2NvcGUuc2xpZGVyVmFsdWUgPSA1MDtcclxuICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBudWxsO1xyXG4gICAgICAgIHZhciBjID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzbWlsZXlDYW52YXNcIik7XHJcbiAgICAgICAgdmFyIGN0eCA9IGMuZ2V0Q29udGV4dChcIjJkXCIpO1xyXG5cclxuICAgICAgICB2YXIgc2FkUkdCID0gWzE1MiwgMzAsIDMwXTtcclxuICAgICAgICB2YXIgaGFwcHlSR0IgPSBbNzAsIDE2MSwgNzNdO1xyXG5cclxuICAgICAgICAvL3RlbGtlbnMgc2xpZGVydmFsdWUgdmVyYW5kZXJ0IGdlemljaHRqZSB0ZWtlbmVuXHJcbiAgICAgICAgJHNjb3BlLiR3YXRjaChcInNsaWRlclZhbHVlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7IC8vY2FudmFzIGNsZWFyZW4gdm9vciBuaWV1dyBmcmFtZVxyXG5cclxuICAgICAgICAgICAgdmFyIG1vb2QgPSAkc2NvcGUuc2xpZGVyVmFsdWU7XHJcbiAgICAgICAgICAgIGdpdmVNb29kV29yZCgpO1xyXG4gICAgICAgICAgICAvL29mZnNldCBwb3NpdGllIG1vbmRcclxuICAgICAgICAgICAgdmFyIG9mZnNldFggPSBjLndpZHRoIC8gNTtcclxuICAgICAgICAgICAgdmFyIG9mZlNldFkgPSBjLndpZHRoIC8gMi4xNCArIChtb29kIC8gKGMud2lkdGggLyA2KSk7XHJcblxyXG4gICAgICAgICAgICAvL3ZhcmlhYmVsZW4gdm9vciBiZXppZXJjdXJ2ZSAoPSBtb25kKVxyXG4gICAgICAgICAgICB2YXIgU1B4ID0gb2Zmc2V0WDtcclxuICAgICAgICAgICAgdmFyIFNQeSA9IG9mZlNldFkgKyBjLndpZHRoIC8gMyAtIChtb29kICogKGMud2lkdGggLyAzNzYuNjYpKTtcclxuICAgICAgICAgICAgdmFyIEgxeCA9IG9mZnNldFg7XHJcbiAgICAgICAgICAgIHZhciBIMXkgPSBvZmZTZXRZICsgKG1vb2QgKiAoYy53aWR0aCAvIDI1MCkpO1xyXG4gICAgICAgICAgICB2YXIgSDJ4ID0gb2Zmc2V0WCArICgoYy53aWR0aCAvIDMwMCkgKiAxODApO1xyXG4gICAgICAgICAgICB2YXIgSDJ5ID0gb2ZmU2V0WSArIChtb29kICogKGMud2lkdGggLyAyNTApKTtcclxuICAgICAgICAgICAgdmFyIEVQeCA9IG9mZnNldFggKyAoYy53aWR0aCAvIDEuNjY2KTtcclxuICAgICAgICAgICAgdmFyIEVQeSA9IG9mZlNldFkgKyAoYy53aWR0aCAvIDMpIC0gKG1vb2QgKiAoYy53aWR0aCAvIDM3Ni42NikpO1xyXG5cclxuICAgICAgICAgICAgLy9ob29mZFxyXG4gICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYy53aWR0aCAvIDYwO1xyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7XHJcbiAgICAgICAgICAgIGN0eC5hcmMoKGMud2lkdGggLyAyKSwgKGMud2lkdGggLyAyKSwgKGMud2lkdGggLyAyLjA3KSwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gXCJyZ2IoXCIgKyBtb29kQ29sb3IoMCkgKyBcIixcIiArIG1vb2RDb2xvcigxKSArIFwiLFwiICsgbW9vZENvbG9yKDIpICsgXCIpXCI7XHJcbiAgICAgICAgICAgIGN0eC5maWxsKCk7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICd3aGl0ZSc7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKTtcclxuXHJcbiAgICAgICAgICAgIC8vbW9uZFxyXG5cclxuICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGMud2lkdGggLyAzMDtcclxuICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICAgICAgICBjdHgubW92ZVRvKFNQeCwgU1B5KTtcclxuICAgICAgICAgICAgY3R4LmJlemllckN1cnZlVG8oSDF4LCBIMXksIEgyeCwgSDJ5LCBFUHgsIEVQeSk7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdibGFjayc7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKTtcclxuICAgICAgICAgICAgY3R4LmxpbmVDYXAgPSBcInJvdW5kXCI7XHJcblxyXG4gICAgICAgICAgICAvL29vZyBsaW5rc1xyXG5cclxuICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGMud2lkdGggLyA2MDtcclxuICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICAgICAgICBjdHguYXJjKGMud2lkdGggLyAzLCBjLndpZHRoIC8gMywgYy53aWR0aCAvIDE1LCAwLCAyICogTWF0aC5QSSk7XHJcbiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnYmxhY2snO1xyXG4gICAgICAgICAgICBjdHguZmlsbCgpO1xyXG4gICAgICAgICAgICBjdHguc3Ryb2tlKCk7XHJcblxyXG4gICAgICAgICAgICAvL29vZyByZWNodHNcclxuICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICAgICAgICBjdHguYXJjKGMud2lkdGggLyAzICogMiwgYy53aWR0aCAvIDMsIGMud2lkdGggLyAxNSwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ2JsYWNrJztcclxuICAgICAgICAgICAgY3R4LmZpbGwoKTtcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgbW9vZENvbG9yID0gZnVuY3Rpb24gKGMpIHtcclxuICAgICAgICAgICAgLy9jOiBSID0gMCwgRyA9IDEsIEIgPSAyXHJcblxyXG4gICAgICAgICAgICBpZiAoc2FkUkdCW2NdID4gaGFwcHlSR0JbY10pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHNhZFJHQltjXSAtICgoc2FkUkdCW2NdIC0gaGFwcHlSR0JbY10pICogKCRzY29wZS5zbGlkZXJWYWx1ZSAvIDEwMCkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHNhZFJHQltjXSArICgoaGFwcHlSR0JbY10gLSBzYWRSR0JbY10pICogKCRzY29wZS5zbGlkZXJWYWx1ZSAvIDEwMCkpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgbW9vZHdvcmRzID0gW1wiaG9ycmlibGVcIiwgXCJyZWFsbHkgYmFkXCIsIFwiYmFkXCIsIFwib2theVwiLCBcImdvb2RcIiwgXCJyZWFsbHkgZ29vZFwiLCBcImV4Y2VsbGVudFwiXTtcclxuXHJcbiAgICAgICAgdmFyIGdpdmVNb29kV29yZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDUpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1swXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCAyNSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzFdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDQwKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbMl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoJHNjb3BlLnNsaWRlclZhbHVlIDwgNjApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1szXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA3NSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzRdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDk1KSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbNV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbNl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkaHR0cC5nZXQoJy9hdXRoL3VzZXInKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICRzY29wZS51c2VyID0gZGF0YTtcclxuICAgICAgICB9KTtcclxuICAgICAgICAkc2NvcGUuc2hhcmVQb3N0ZWQgPSBmYWxzZTtcclxuICAgICAgICAkc2NvcGUucG9zdFNoYXJlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkc2NvcGUuc2hhcmVQb3N0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBwcm9maWxlU2VydmljZS5nZXRVc2VyKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1c2VybGVzc1NoYXJlRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInVzZXJpZFwiOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZXZlbnRpZFwiOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidGltZVwiOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJtb29kXCI6ICRzY29wZS5zbGlkZXJWYWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImxhdFwiOiBwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsbmdcIjogcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zYXZlVXNlcmxlc3NTaGFyZSh1c2VybGVzc1NoYXJlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidXNlcmlkXCI6ICRzY29wZS51c2VyLl9pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImV2ZW50aWRcIjogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInRpbWVcIjogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwibW9vZFwiOiAkc2NvcGUuc2xpZGVyVmFsdWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsYXRcIjogcG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwibG5nXCI6IHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVNlcnZpY2UucG9zdFNoYXJlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3I6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiaW50cm9Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcInNoYXJlU2VydmljZVwiLCBcIiRodHRwXCIsIFwiJGxvY2F0aW9uXCIsIFwicHJvZmlsZVNlcnZpY2VcIixcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIGludHJvQ29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IExpZW5lcnQgb24gMjEvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGludHJvX3NoYXJlZENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBzaGFyZVZhcnNCZXR3ZWVuQ3RybCxwcm9maWxlU2VydmljZSkge1xyXG4gICAgICAgICRzY29wZS5pbmZvUG9zdGVkU2hhcmUgPSBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5nZXRQcm9wZXJ0eSgpLnNoYXJlO1xyXG4gICAgfTtcclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImludHJvX3NoYXJlZENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwic2hhcmVWYXJzQmV0d2VlbkN0cmxcIixcInByb2ZpbGVTZXJ2aWNlXCIsIGludHJvX3NoYXJlZENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDI2LzExLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBsb2dpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkaHR0cCwgJGxvY2F0aW9uLCBzaGFyZVZhcnNCZXR3ZWVuQ3RybCwgc2hhcmVTZXJ2aWNlLCBwcm9maWxlU2VydmljZSkge1xyXG5cclxuICAgICAgICB2YXIgcG9zdFVzZXJsZXNzU2hhcmUgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICB2YXIgc2hhcmVEYXRhID0gc2hhcmVWYXJzQmV0d2VlbkN0cmwucmV0dXJuVXNlcmxlc3NTaGFyZSgpO1xyXG4gICAgICAgICAgICBwcm9maWxlU2VydmljZS5nZXRVc2VyKGZ1bmN0aW9uIChlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXIucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgodXNlci5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVEYXRhLnVzZXJpZCA9IHVzZXIuaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlU2VydmljZS5wb3N0U2hhcmUoc2hhcmVEYXRhKTsgLy9wb3N0IGRlIHNoYXJlIG1ldCBkZSBpbmxvZ2RhdGEgZGF0IGhpaiBudSB3ZWV0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlVmFyc0JldHdlZW5DdHJsLnNhdmVVc2VybGVzc1NoYXJlKFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIHByb2ZpbGVTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5sb2dpbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJGh0dHAucG9zdCgnaHR0cDovL2xvY2FsaG9zdDozMDAwL2F1dGgvbG9naW4nLCB7XHJcbiAgICAgICAgICAgICAgICB1c2VybmFtZTogJHNjb3BlLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6ICRzY29wZS5wYXNzd29yZFxyXG4gICAgICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNoYXJlVmFyc0JldHdlZW5DdHJsLnJldHVyblVzZXJsZXNzU2hhcmUoKSAhPT0gdW5kZWZpbmVkICYmIHNoYXJlVmFyc0JldHdlZW5DdHJsLnJldHVyblVzZXJsZXNzU2hhcmUoKSAhPT0gXCJcIikgLy91c2VyIGhlZWZ0IHdpbGxlbiBzaGFyZW4sIG1hYXIgd2FzIG5pZXQgaW5nZWxvZ2QuXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zdFVzZXJsZXNzU2hhcmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUucmVnaXN0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRodHRwLnBvc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hdXRoL3JlZ2lzdGVyJywge1xyXG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6ICRzY29wZS51c2VybmFtZSxcclxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiAkc2NvcGUucGFzc3dvcmQsXHJcbiAgICAgICAgICAgICAgICBlbWFpbDogJHNjb3BlLmVtYWlsXHJcbiAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2hhcmVWYXJzQmV0d2VlbkN0cmwucmV0dXJuVXNlcmxlc3NTaGFyZSgpICE9PSB1bmRlZmluZWQgJiYgc2hhcmVWYXJzQmV0d2VlbkN0cmwucmV0dXJuVXNlcmxlc3NTaGFyZSgpICE9PSBcIlwiKSAvL3VzZXIgaGVlZnQgd2lsbGVuIHNoYXJlbiwgbWFhciB3YXMgbmlldCBpbmdlbG9nZC5cclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBwb3N0VXNlcmxlc3NTaGFyZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImxvZ2luQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIFwic2hhcmVTZXJ2aWNlXCIsIFwicHJvZmlsZVNlcnZpY2VcIiwgbG9naW5Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyMS8xMS8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgbWFpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBnb29nbGVNYXBzU2VydmljZSwgc2hhcmVTZXJ2aWNlLCBldmVudFNlcnZpY2UpIHtcclxuICAgICAgICBzaGFyZVNlcnZpY2UuZ2V0QWxsU2hhcmVzKGZ1bmN0aW9uIChlcnIsIHNoYXJlcykge1xyXG4gICAgICAgICAgICBpZiAoIWVycikge1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2Uuc2hvd0xvY2F0aW9uT25NYXAoKTtcclxuICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLnNob3dBbGxNYXJrZXJzKHNoYXJlcyk7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hhcmVzID0gc2hhcmVzO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVsYXBzZSA9IDEwMDtcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lc3RhbXAgPSBcIkFsbCB0aW1lXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIj4gZXJyb3IgaW4gc2hhcmVTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHNjb3BlLiR3YXRjaChcInRpbWVsYXBzZVwiLCBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYoJHNjb3BlLnRpbWVsYXBzZSA+PSA4MCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwiQWxsIHRpbWVcIjtcclxuICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLnNob3dBbGxNYXJrZXJzKCRzY29wZS5zaGFyZXMpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYoJHNjb3BlLnRpbWVsYXBzZSA+PSA2MCAmJiAkc2NvcGUudGltZWxhcHNlIDwgODApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lc3RhbXAgPSBcIkxhc3QgeWVhclwiO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2Uuc2hvd0FsbE1hcmtlcnMoZmlsdGVyU2hhcmVzT25UaW1lKG5ldyBEYXRlKDEsIDAsIDAsIDAsIDAsIDAsIDApKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZigkc2NvcGUudGltZWxhcHNlID49IDQwICYmICRzY29wZS50aW1lbGFwc2UgPCA2MCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwiTGFzdCBtb250aFwiO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2Uuc2hvd0FsbE1hcmtlcnMoZmlsdGVyU2hhcmVzT25UaW1lKG5ldyBEYXRlKDAsIDEsIDAsIDAsIDAsIDAsIDApKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZigkc2NvcGUudGltZWxhcHNlID49IDIwICYmICRzY29wZS50aW1lbGFwc2UgPCA0MCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwiTGFzdCB3ZWVrXCI7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5zaG93QWxsTWFya2VycyhmaWx0ZXJTaGFyZXNPblRpbWUobmV3IERhdGUoMCwgMCwgNywgMCwgMCwgMCwgMCkpKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKCRzY29wZS50aW1lbGFwc2UgPiAwICYmICRzY29wZS50aW1lbGFwc2UgPCAyMCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwiTGFzdCBkYXlcIjtcclxuICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLnNob3dBbGxNYXJrZXJzKGZpbHRlclNoYXJlc09uVGltZShuZXcgRGF0ZSgwLCAwLCAxLCAwLCAwLCAwLCAwKSkpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwibGFzdCBob3VyXCI7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5zaG93QWxsTWFya2VycyhmaWx0ZXJTaGFyZXNPblRpbWUobmV3IERhdGUoMCwgMCwgMCwgMSwgMCwgMCwgMCkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgZmlsdGVyU2hhcmVzT25UaW1lID0gZnVuY3Rpb24odGltZWFnbykge1xyXG4gICAgICAgICAgICB2YXIgc2hhcmVzID0gW107XHJcbiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCgkc2NvcGUuc2hhcmVzLCBmdW5jdGlvbihzaGFyZSkge1xyXG4gICAgICAgICAgICAgICAgaWYodGltZWFnbyA8PSAobmV3IERhdGUoKSAtIHNoYXJlLnRpbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hhcmVzLnB1c2goc2hhcmUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHNoYXJlcztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcIm1haW5Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcImdvb2dsZU1hcHNTZXJ2aWNlXCIsIFwic2hhcmVTZXJ2aWNlXCIsIFwiZXZlbnRTZXJ2aWNlXCIsIG1haW5Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyNS8xMS8yMDE1LlxyXG4gKi9cclxuXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIHNlYXJjaENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBzZWFyY2hTZXJ2aWNlLCBzaGFyZWRQcm9wZXJ0aWVzKSB7XHJcblxyXG4gICAgICAgICRzY29wZS5zZWFyY2hNb2RlbCA9IG51bGw7XHJcblxyXG4gICAgICAgICRzY29wZS5zZWFyY2hPblN1Ym1pdCA9IGZ1bmN0aW9uIChmb3JtT2JqKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2VhcmNoTW9kZWwubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoTm93KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgICRzY29wZS5zZWFyY2hPbktleVByZXNzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoJHNjb3BlLnNlYXJjaE1vZGVsICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hOb3coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5maWx0ZXJTZWFyY2hSZXN1bHRzID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgICAgaWYgKCRzY29wZS5zZWFyY2hNb2RlbCA9PT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaS51c2VybmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJHNjb3BlLnNlYXJjaE1vZGVsLnRvTG9jYWxlTG93ZXJDYXNlKCkpID49IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpLmRlc2NyaXB0aW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChpLmRlc2NyaXB0aW9uLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigkc2NvcGUuc2VhcmNoTW9kZWwudG9Mb2NhbGVMb3dlckNhc2UoKSkgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfTtcclxuXHJcblxyXG4gICAgICAgIHZhciBzZWFyY2hOb3cgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHNlYXJjaFNlcnZpY2Uuc2VhcmNoKCRzY29wZS5zZWFyY2hNb2RlbCkudGhlbihvblJlc3VsdHNSZWFkeSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIG9uUmVzdWx0c1JlYWR5ID0gZnVuY3Rpb24gKHJlcykge1xyXG4gICAgICAgICAgICAkc2NvcGUuc2VhcmNoUmVzdWx0cyA9IHJlcztcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgb25SZXN1bHRzRXJyb3IgPSBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwic2VhcmNoQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCJzZWFyY2hTZXJ2aWNlXCIsXCJzaGFyZWRQcm9wZXJ0aWVzXCIsIHNlYXJjaENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDIxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBtZUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkaHR0cCwgJGxvY2F0aW9uLCBwcm9maWxlU2VydmljZSwgc2hhcmVTZXJ2aWNlLCBldmVudFNlcnZpY2UpIHtcclxuICAgICAgICBwcm9maWxlU2VydmljZS5nZXRVc2VyKGZ1bmN0aW9uIChlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgIGlmICh1c2VyLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgodXNlci5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyID0gdXNlcjtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXNlci5hZGRyZXNzMSA9IHNwbGl0QWRkcmVzcyh1c2VyLmFkZHJlc3MsIDApO1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyLmFkZHJlc3MyID0gc3BsaXRBZGRyZXNzKHVzZXIuYWRkcmVzcywgMSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNoYXJlU2VydmljZS5nZXRTaGFyZXNCeVVzZXJJZCh1c2VyLmlkLCBmdW5jdGlvbiAoZXJyLCBzaGFyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2hhcmVzLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoc2hhcmVzLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNoYXJlcywgZnVuY3Rpb24oc2hhcmUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzaGFyZS5ldmVudGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudFNlcnZpY2UuZ2V0RXZlbnRCeUlkKHNoYXJlLmV2ZW50aWQsIGZ1bmN0aW9uIChlcnIsIGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZS5hZGRyZXNzID0gZXZlbnQuZXZlbnRuYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiPiBlcnJvciBldmVudFNlcnZpY2U6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2hhcmVzZm9ycHJvZmlsZSA9IHNoYXJlcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiPiBlcnJvciBzaGFyZVNlcnZpY2U6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yIHByb2ZpbGVTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNhdmUgPSBmdW5jdGlvbiAodXNlcikge1xyXG4gICAgICAgICAgICB1c2VyLmFkZHJlc3MgPSBtYWtlQWRkcmVzcyh1c2VyLmFkZHJlc3MxLCB1c2VyLmFkZHJlc3MyKTtcclxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2Uuc2F2ZVVzZXIodXNlciwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXNlci5hZGRyZXNzMSA9IHNwbGl0QWRkcmVzcyhkYXRhLmFkZHJlc3MsIDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXNlci5hZGRyZXNzMiA9IHNwbGl0QWRkcmVzcyhkYXRhLmFkZHJlc3MsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCI+IGVycm9yOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5sb2dvdXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHByb2ZpbGVTZXJ2aWNlLmxvZ291dCgpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgc3BsaXRBZGRyZXNzID0gZnVuY3Rpb24gKGFkZHJlc3MsIHBhcnQpIHtcclxuICAgICAgICAgICAgdmFyIHNwbGl0ID0gYWRkcmVzcy5zcGxpdChcIixcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGxpdFtwYXJ0XTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgbWFrZUFkZHJlc3MgPSBmdW5jdGlvbiAoYWRkcmVzczEsIGFkZHJlc3MyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhZGRyZXNzMSArIFwiLFwiICsgYWRkcmVzczI7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwibWVDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRodHRwXCIsIFwiJGxvY2F0aW9uXCIsIFwicHJvZmlsZVNlcnZpY2VcIiwgXCJzaGFyZVNlcnZpY2VcIiwgXCJldmVudFNlcnZpY2VcIiwgbWVDb250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciB1c2VyQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRsb2NhdGlvbiwgc2VhcmNoU2VydmljZSwgc2hhcmVTZXJ2aWNlLCAkcm91dGVQYXJhbXMpIHtcclxuXHJcbiAgICAgICAgJHNjb3BlLmluaXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB1c2VyaWQgPSAkcm91dGVQYXJhbXMucGFyYW07XHJcbiAgICAgICAgICAgIHNlYXJjaFNlcnZpY2Uuc2VhcmNoVXNlckZyb21JZCh1c2VyaWQpLnRoZW4odXNlckZvdW5kV2l0aElkKTtcclxuXHJcbiAgICAgICAgICAgIHNoYXJlU2VydmljZS5nZXRTaGFyZXNCeVVzZXJJZCh1c2VyaWQsIGZ1bmN0aW9uIChlcnIsIHNoYXJlcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2hhcmVGb3VuZFdpdGhVc2VySWQgPSBzaGFyZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZlZWxpbmdJbWFnZXMgPSBbXCJkZXByZXNzZWRcIiwgXCJzYWRcIiwgXCJjb21tb25cIiwgXCJoYXBweVwiLCBcImV4Y2l0ZWRcIl07XHJcbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNoYXJlcywgZnVuY3Rpb24gKHNoYXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlLm1vb2RJbWFnZVNvdXJjZSA9IFwiLi9hc3NldHMvXCIgKyBmZWVsaW5nSW1hZ2VzW2dpdmVGZWVsaW5nc0ltYWdlQXJyYXlOdW1iZXIoc2hhcmUpXSArIFwiLnBuZ1wiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUubWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjoge2xhdDogc2hhcmUubGF0LCBsbmc6IHNoYXJlLmxuZ30sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6ICRzY29wZS5tYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBzaGFyZS5tb29kSW1hZ2VTb3VyY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiPiBlcnJvciBpbiBzaGFyZVNlcnZpY2U6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHVzZXJGb3VuZFdpdGhJZCA9IGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgJHNjb3BlLnVzZXJmb3VuZHdpdGhpZCA9IHJlcztcclxuXHJcbiAgICAgICAgICAgIGlmIChyZXMubGF0ICE9PSB1bmRlZmluZWQgJiYgcmVzLmxhdCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubWFwLnNldENlbnRlcihuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHJlcy5sYXQsIHJlcy5sbmcpKTtcclxuICAgICAgICAgICAgICAgIGlmICgkc2NvcGUubWFya2VyICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubWFya2VyLnNldE1hcChudWxsKTsgLy92ZXJ3aWpkZXJ0IGFsbGUgbWFya2VycyBlZXJzdFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiB7bGF0OiByZXMubGF0LCBsbmc6IHJlcy5sbmd9LFxyXG4gICAgICAgICAgICAgICAgICAgIG1hcDogJHNjb3BlLm1hcCxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOiAkc2NvcGUuaW1hZ2VcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGdpdmVGZWVsaW5nc0ltYWdlQXJyYXlOdW1iZXIgPSBmdW5jdGlvbiAoc2hhcmUpIHtcclxuICAgICAgICAgICAgaWYgKHNoYXJlLm1vb2QgPiA4MCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChzaGFyZS5tb29kIC8gMjApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwidXNlckNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGxvY2F0aW9uXCIsIFwic2VhcmNoU2VydmljZVwiLCBcInNoYXJlU2VydmljZVwiLCBcIiRyb3V0ZVBhcmFtc1wiLCB1c2VyQ29udHJvbGxlcl0pO1xyXG59KVxyXG4oKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDI4LzEyLzIwMTUuXHJcbiAqL1xyXG5cclxudmFyIGV2ZW50U2VydmljZSA9IGZ1bmN0aW9uICgkaHR0cCwgZ29vZ2xlTWFwc1NlcnZpY2UpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIC8vcHJpdmF0ZVxyXG5cclxuICAgIC8vcHVibGljXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGdldEV2ZW50QnlJZCA6IGZ1bmN0aW9uIChldmVudGlkLCBjYikge1xyXG4gICAgICAgICAgICAkaHR0cC5nZXQoXCIvYXBpL2V2ZW50L1wiICsgZXZlbnRpZCkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmFkZHJlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgbmV3IEdmRXZlbnQoZGF0YS5faWQsIGRhdGEuZXZlbnRuYW1lLCBkYXRhLmV2ZW50aW1hZ2UsIGRhdGEuYXV0aG9yaWQsIG5ldyBEYXRlIChkYXRhLmZyb20pLCBuZXcgRGF0ZShkYXRhLnVudGlsKSwgZGF0YS5sYXQsIGRhdGEubG5nLCBkYXRhLmFkZHJlc3MpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0Q29vcmRpbmF0ZXNUb0FkcmVzcyhkYXRhLmxhdCwgZGF0YS5sbmcsIGZ1bmN0aW9uKGVyciwgYWRkcmVzcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGNiKG51bGwsIG5ldyBHZkV2ZW50KGRhdGEuX2lkLCBkYXRhLmV2ZW50bmFtZSwgZGF0YS5ldmVudGltYWdlLCBkYXRhLmF1dGhvcmlkLCBuZXcgRGF0ZShkYXRhLmZyb20pLCBuZXcgRGF0ZShkYXRhLnVudGlsKSwgZGF0YS5sYXQsIGRhdGEubG5nLCBhZGRyZXNzKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihlcnIsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBwb3N0RXZlbnQgOiBmdW5jdGlvbihkYXRhLCBjYikge1xyXG4gICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0QWRyZXNzVG9Db29yZGluYXRlcyhkYXRhLmFkZHJlc3MsIGZ1bmN0aW9uKGVyciwgY29vcmQpIHtcclxuICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmxhdCA9IGNvb3JkLmxhdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEubG5nID0gY29vcmQubG5nKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRodHRwLnBvc3QoXCIvYXBpL2V2ZW50XCIsIG5ldyBHZkV2ZW50KGRhdGEuX2lkLCBkYXRhLmV2ZW50bmFtZSwgZGF0YS5ldmVudGltYWdlLCBkYXRhLmF1dGhvcmlkLCBuZXcgRGF0ZShkYXRhLmZyb20pLCBuZXcgRGF0ZShkYXRhLnVudGlsKSwgZGF0YS5sYXQsIGRhdGEubG5nLCBkYXRhLmFkZHJlc3MpKS5zdWNjZXNzKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHJlc3BvbnNlKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKGVycm9yLCBudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoZXJyLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgdXBkYXRlRXZlbnQgOiBmdW5jdGlvbihkYXRhLCBjYikge1xyXG4gICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0QWRyZXNzVG9Db29yZGluYXRlcyhkYXRhLmFkZHJlc3MsIGZ1bmN0aW9uIChlcnIsIGNvb3JkKSB7XHJcbiAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5sYXQgPSBjb29yZC5sYXQoKTtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmxuZyA9IGNvb3JkLmxuZygpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkaHR0cC5wdXQoXCIvYXBpL2V2ZW50L1wiICsgZGF0YS5pZCwgZGF0YSkuc3VjY2VzcyhmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgbmV3IEdmRXZlbnQocmVzcG9uc2UuX2lkLCByZXNwb25zZS5ldmVudG5hbWUsIHJlc3BvbnNlLmV2ZW50aW1hZ2UsIHJlc3BvbnNlLmF1dGhvcmlkLCBuZXcgRGF0ZShyZXNwb25zZS5mcm9tKSwgbmV3IERhdGUocmVzcG9uc2UudW50aWwpLCByZXNwb25zZS5sYXQsIHJlc3BvbnNlLmxuZywgcmVzcG9uc2UuYWRkcmVzcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKGVyciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcblxyXG5hbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJldmVudFNlcnZpY2VcIiwgW1wiJGh0dHBcIiwgXCJnb29nbGVNYXBzU2VydmljZVwiLCBldmVudFNlcnZpY2VdKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDIyLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vbWFwcy9kb2N1bWVudGF0aW9uL2dlb2NvZGluZy9pbnRybz9jc3c9MSNHZW9jb2RpbmdcclxuLy8gRGl0IGdlYnJ1aWtlbiBvbSBhZHJlc3NlbiB0ZSB2ZXJ0YWxlbiBuYWFyIGxhdCBlbiBsbmcgb2Ygb21nZWtlZXJkXHJcbi8vIFdhYXJvbT8gPT4gZ29vZ2xlIG1hcHMgd2Vya3QgbWV0IGxhdCBlbiBsbmcsIHdvcmR0IHpvIG9wZ2VzbGFhbiBpbiBkZSBkYXRhYmFzZVxyXG5cclxudmFyIGdvb2dsZU1hcHNTZXJ2aWNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICAvLyBwcml2YXRlXHJcbiAgICB2YXIgbWFwb3B0aW9ucyA9IHtcclxuICAgICAgICB6b29tOiAxMCxcclxuICAgICAgICBtYXBUeXBlSWQ6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQLFxyXG4gICAgICAgIGRpc2FibGVEZWZhdWx0VUk6IHRydWVcclxuICAgIH07XHJcbiAgICB2YXIgZ2VvY29kZXIgPSBuZXcgZ29vZ2xlLm1hcHMuR2VvY29kZXIoKTtcclxuICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjbWFwXCIpLCBtYXBvcHRpb25zKTtcclxuXHJcbiAgICB2YXIgY2hvb3NlSWNvbiA9IGZ1bmN0aW9uKG1vb2QpIHtcclxuICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vc3R1ZGVudC5ob3dlc3QuYmUvam9uYXRhbi5taWNoaWVscy9nZW9mZWVsaW5ncy9hc3NldHMvXCI7XHJcbiAgICAgICAgaWYobW9vZCA8PSAyMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsICs9IFwiZGVwcmVzc2VkLnBuZ1wiO1xyXG4gICAgICAgIH0gZWxzZSBpZihtb29kID4gMjAgJiYgbW9vZCA8PSA0MCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsICs9IFwic2FkLnBuZ1wiO1xyXG4gICAgICAgIH0gZWxzZSBpZihtb29kID4gNDAgJiYgbW9vZCA8PSA2MCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsICs9IFwiY29tbW9uLnBuZ1wiO1xyXG4gICAgICAgIH0gZWxzZSBpZihtb29kID4gNjAgJiYgbW9vZCA8PSA4MCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsICs9IFwiaGFwcHkucG5nXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVybCArPSBcImV4Y2l0ZWQucG5nXCI7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvL3B1YmxpY1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzaG93TG9jYXRpb25Pbk1hcDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZihuYXZpZ2F0b3IuZ2VvbG9jYXRpb24pIHtcclxuICAgICAgICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWFwLnNldENlbnRlcihuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHBvc2l0aW9uLmNvb3Jkcy5sYXRpdHVkZSwgcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IG1hcC5nZXRDZW50ZXIoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGljb246IFwiaHR0cDovL3N0dWRlbnQuaG93ZXN0LmJlL2pvbmF0YW4ubWljaGllbHMvZ2VvZmVlbGluZ3MvYXNzZXRzL2xvY2F0aW9uX25vdy5wbmdcIlxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBUaHJvdyBtYXAgZXhjZXB0aW9uXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBzaG93QWxsTWFya2VyczogZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgdmFyIG1hcmtlciwgaTtcclxuICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoZGF0YVtpXS5sYXQsIGRhdGFbaV0ubG5nKSxcclxuICAgICAgICAgICAgICAgICAgICBtYXA6IG1hcCxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOiBjaG9vc2VJY29uKGRhdGFbaV0ubW9vZClcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBpbmZvV2luZG93ID0gbmV3IGdvb2dsZS5tYXBzLkluZm9XaW5kb3coKTtcclxuICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gXCI8aDQgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IFNoYXJlIGRldGFpbHMgPC9oND5cIiArIFwiPHAgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IE1vb2Q6IDxzcGFuPlwiICsgZGF0YVtpXS5tb29kICsgXCIlPC9zcGFuPjwvcD5cIiArIFwiPHAgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IFRpbWU6IDxzcGFuPlwiICsgbmV3IERhdGUoZGF0YVtpXS50aW1lKSArIFwiPC9zcGFuPjwvcD5cIiArIFwiPHAgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IEFkZHJlc3M6IDxzcGFuPlwiICsgZGF0YVtpXS5hZGRyZXNzICsgXCI8L3NwYW4+PC9wPlwiICsgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gRXZlbnQ6IDxzcGFuPlwiKyBkYXRhW2ldLmV2ZW50aWQgKyBcIjwvc3Bhbj48L3A+XCI7XHJcblxyXG4gICAgICAgICAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCBcImNsaWNrXCIsIChmdW5jdGlvbiAobWFya2VyLCBjb250ZW50LCBpbmZvV2luZG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5mb1dpbmRvdy5zZXRDb250ZW50KGNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbmZvV2luZG93Lm9wZW4obWFwLCBtYXJrZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9KShtYXJrZXIsIGNvbnRlbnQsIGluZm9XaW5kb3cpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGNvbnZlcnRBZHJlc3NUb0Nvb3JkaW5hdGVzOiBmdW5jdGlvbiAoYWRkcmVzcywgY2IpIHtcclxuICAgICAgICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7YWRkcmVzczogYWRkcmVzc30sIGZ1bmN0aW9uIChyZXN1bHRzLCBzdGF0dXMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT0gZ29vZ2xlLm1hcHMuR2VvY29kZXJTdGF0dXMuT0spIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2Ioc3RhdHVzLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgY29udmVydENvb3JkaW5hdGVzVG9BZHJlc3M6IGZ1bmN0aW9uIChsYXQsIGxuZywgY2IpIHtcclxuICAgICAgICAgICAgdmFyIGxvY2F0aW9uID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhsYXQsIGxuZyk7XHJcbiAgICAgICAgICAgIGdlb2NvZGVyLmdlb2NvZGUoe2xhdExuZzogbG9jYXRpb259LCBmdW5jdGlvbiAocmVzdWx0cywgc3RhdHVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhdHVzID09IGdvb2dsZS5tYXBzLkdlb2NvZGVyU3RhdHVzLk9LKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgcmVzdWx0c1swXS5mb3JtYXR0ZWRfYWRkcmVzcyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PSBnb29nbGUubWFwcy5HZW9jb2RlclN0YXR1cy5PVkVSX1FVRVJZX0xJTUlUKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXN1bHRzWzBdLmZvcm1hdHRlZF9hZGRyZXNzKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAyMDApO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihzdGF0dXMsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5mYWN0b3J5KFwiZ29vZ2xlTWFwc1NlcnZpY2VcIiwgW2dvb2dsZU1hcHNTZXJ2aWNlXSk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyNy8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbnZhciBwcm9maWxlU2VydmljZSA9IGZ1bmN0aW9uICgkaHR0cCwgZ29vZ2xlTWFwc1NlcnZpY2UpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIC8vIHByaXZhdGVcclxuXHJcbiAgICAvL3B1YmxpY1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBnZXRVc2VyIDogZnVuY3Rpb24gKGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hdXRoL3VzZXJcIikuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBuZXcgR2ZVc2VyKGRhdGEuX2lkLCBkYXRhLnVzZXJuYW1lLCBkYXRhLmVtYWlsLCBkYXRhLnVzZXJpbWFnZSwgbmV3IERhdGUoZGF0YS5hZ2UpLCBkYXRhLmxhdCwgZGF0YS5sbmcsIGRhdGEuYWRkcmVzcywgZGF0YS5jaGF0LCBkYXRhLmFkbWluKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBzYXZlVXNlciA6IGZ1bmN0aW9uICh1c2VyLCBjYikge1xyXG4gICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0QWRyZXNzVG9Db29yZGluYXRlcyh1c2VyLmFkZHJlc3MsIGZ1bmN0aW9uKGVyciwgY29vcmQpIHtcclxuICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyLmxhdCA9IGNvb3JkLmxhdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXIubG5nID0gY29vcmQubG5nKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRodHRwLnB1dChcIi9hcGkvdXNlci9cIiArIHVzZXIuaWQsIHVzZXIpLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBuZXcgR2ZVc2VyKGRhdGEuX2lkLCBkYXRhLnVzZXJuYW1lLCBkYXRhLmVtYWlsLCBkYXRhLnVzZXJpbWFnZSwgbmV3IERhdGUoZGF0YS5hZ2UpLCBkYXRhLmxhdCwgZGF0YS5sbmcsIGRhdGEuYWRkcmVzcywgZGF0YS5jaGF0LCBkYXRhLmFkbWluKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihlcnIsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBsb2dvdXQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQoXCIvYXV0aC9sb2dvdXRcIikudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcblxyXG5hbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJwcm9maWxlU2VydmljZVwiLCBbXCIkaHR0cFwiLCBcImdvb2dsZU1hcHNTZXJ2aWNlXCIsIHByb2ZpbGVTZXJ2aWNlXSk7IiwiKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBzZWFyY2hTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwKSB7XHJcblxyXG4gICAgICAgIHZhciBzZWFyY2ggPSBmdW5jdGlvbiAoc2VhcmNoU3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS91c2VyLyc7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgYXJTZWFyY2hSZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2gocmVzcG9uc2UuZGF0YSwgZnVuY3Rpb24gKHNlYXJjaFIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U1IgPSBuZXcgU2VhcmNoUmVzdWx0KHNlYXJjaFIuX2lkLCBzZWFyY2hSLnVzZXJuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBhclNlYXJjaFJlc3VsdHMucHVzaChuZXdTUik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhclNlYXJjaFJlc3VsdHM7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBzZWFyY2hVc2VyRnJvbUlkID0gZnVuY3Rpb24gKHNlYXJjaFN0cmluZykge1xyXG4gICAgICAgICAgICB2YXIgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvdXNlci8nICsgc2VhcmNoU3RyaW5nO1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgR2ZVc2VyKFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuX2lkLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEudXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5lbWFpbCxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnVzZXJpbWFnZSxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFnZSxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmxhdCxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmxuZyxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmNoYXQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5hZG1pblxyXG4gICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHNlYXJjaDogc2VhcmNoLFxyXG4gICAgICAgICAgICBzZWFyY2hVc2VyRnJvbUlkOiBzZWFyY2hVc2VyRnJvbUlkXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJzZWFyY2hTZXJ2aWNlXCIsIFtcIiRodHRwXCIsIHNlYXJjaFNlcnZpY2VdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBMaWVuZXJ0IG9uIDIzLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIE9QTUVSS0lORyBWT09SIExJRU5FUlQhISEhXHJcbiAqIHBvc3Qgc2hhcmUgemFsIG5pZXQgd2Vya2VuXHJcbiAqIGltcGxlbWVudGVlciBnb29nbGVTZXJ2aWNlXHJcbiAqIHZvb3JiZWVsZCBrYW4gamUgdmluZGVuIGluIHByb2ZpbGVzZXJ2aWNlIChwdXQgZnVuY3RpZSlcclxuICogR3JvZXRqZXMgSm9uYXRhblxyXG4gKi9cclxuXHJcblxyXG52YXIgc2hhcmVTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwLCAkbG9jYXRpb24sIGdvb2dsZU1hcHNTZXJ2aWNlLCBzaGFyZVZhcnNCZXR3ZWVuQ3RybCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgLy9wcml2YXRlXHJcbiAgICB2YXIgbWFrZUFkZHJlc3MgPSBmdW5jdGlvbiAoYWRkcmVzcykge1xyXG4gICAgICAgIGlmKGFkZHJlc3MpIHtcclxuICAgICAgICAgICAgdmFyIHNwbGl0ID0gYWRkcmVzcy5zcGxpdChcIixcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGxpdFswXSArIFwiLCBcIiArIHNwbGl0WzFdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgdmFyIHBvc3RTaGFyZSA9IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgJGh0dHAoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3NoYXJlJyxcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGFcclxuICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChzZXJ2ZXJEYXRhKSB7XHJcbiAgICAgICAgICAgIHNoYXJlVmFyc0JldHdlZW5DdHJsLnNldFByb3BlcnR5KHNlcnZlckRhdGEpOyAvL2RhdGEga3VubmVuIGRvb3JnZXZlbiBhYW4gaW50cm9fc2hhcmVkQ29udHJvbGxlclxyXG4gICAgICAgICAgICAkbG9jYXRpb24ucGF0aChcImludHJvX3NoYXJlZFwiKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgLy9wdWJsaWNcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgcG9zdFNoYXJlOiBwb3N0U2hhcmUsXHJcbiAgICAgICAgcG9zdFNoYXJlQXN5bmM6IGZ1bmN0aW9uIChkYXRhLCBjYikge1xyXG4gICAgICAgICAgICBpZihkYXRhLmFkZHJlc3MpIHtcclxuICAgICAgICAgICAgICAgICRodHRwLnBvc3QoXCIvYXBpL3NoYXJlXCIsIGRhdGEpLnN1Y2Nlc3MoZnVuY3Rpb24ocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgbmV3IEdmU2hhcmUoZGF0YS5faWQsIGRhdGEudXNlcmlkLCBkYXRhLmV2ZW50aWQsIGRhdGEudGltZSwgZGF0YS5tb29kLCBkYXRhLmxhdCwgZGF0YS5sbmcsIG1ha2VBZGRyZXNzKGRhdGEuYWRkcmVzcykpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLmNvbnZlcnRDb29yZGluYXRlc1RvQWRyZXNzKGRhdGEubGF0LCBkYXRhLmxuZywgZnVuY3Rpb24oZXJyLCBhZGRyZXNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KFwiL2FwaS9zaGFyZVwiLCBkYXRhKS5zdWNjZXNzKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgbmV3IEdmU2hhcmUoZGF0YS5faWQsIGRhdGEudXNlcmlkLCBkYXRhLmV2ZW50aWQsIGRhdGEudGltZSwgZGF0YS5tb29kLCBkYXRhLmxhdCwgZGF0YS5sbmcsIG1ha2VBZGRyZXNzKGFkZHJlc3MpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnIsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgZ2V0U2hhcmVzQnlVc2VySWQ6IGZ1bmN0aW9uICh1c2VyaWQsIGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvc2hhcmUvdXNlci9cIiArIHVzZXJpZCkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcmVzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGRhdGEsIGZ1bmN0aW9uKHNoYXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlcy5wdXNoKG5ldyBHZlNoYXJlKHNoYXJlLl9pZCwgc2hhcmUudXNlcmlkLCBzaGFyZS5ldmVudGlkLCBzaGFyZS50aW1lLCBzaGFyZS5tb29kLCBzaGFyZS5sYXQsIHNoYXJlLmxuZywgbWFrZUFkZHJlc3Moc2hhcmUuYWRkcmVzcykpKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBzaGFyZXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGNiKGVycm9yLCBudWxsKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgZ2V0U2hhcmVzQnlFdmVudElkOiBmdW5jdGlvbiAoZXZlbnRpZCwgY2IpIHtcclxuICAgICAgICAgICAgJGh0dHAuZ2V0KFwiL2FwaS9zaGFyZS9ldmVudC9cIiArIGV2ZW50aWQpLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLCBmdW5jdGlvbihzaGFyZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaGFyZXMucHVzaChuZXcgR2ZTaGFyZShzaGFyZS5faWQsIHNoYXJlLnVzZXJpZCwgc2hhcmUuZXZlbnRpZCwgc2hhcmUudGltZSwgc2hhcmUubW9vZCwgc2hhcmUubGF0LCBzaGFyZS5sbmcsIG1ha2VBZGRyZXNzKHNoYXJlLmFkZHJlc3MpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgc2hhcmVzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGdldEFsbFNoYXJlczogZnVuY3Rpb24gKGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvc2hhcmVcIikuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNoYXJlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGRhdGEsIGZ1bmN0aW9uKHNoYXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hhcmVzLnB1c2gobmV3IEdmU2hhcmUoc2hhcmUuX2lkLCBzaGFyZS51c2VyaWQsIHNoYXJlLmV2ZW50aWQsIHNoYXJlLnRpbWUsIHNoYXJlLm1vb2QsIHNoYXJlLmxhdCwgc2hhcmUubG5nLCBtYWtlQWRkcmVzcyhzaGFyZS5hZGRyZXNzKSkpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBzaGFyZXMpO1xyXG4gICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbihlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5hbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJzaGFyZVNlcnZpY2VcIiwgW1wiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgXCJnb29nbGVNYXBzU2VydmljZVwiLCBcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIHNoYXJlU2VydmljZV0pO1xyXG4iLCIvKipcclxuICogQ3JlYXRlZCBieSBsaWVuZSBvbiAyOC8xMi8yMDE1LlxyXG4gKi9cclxuXHJcblxyXG52YXIgc2hhcmVWYXJzQmV0d2VlbkN0cmwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICAvL3ByaXZhdGVcclxuICAgIHZhciBwcm9wZXJ0eTtcclxuICAgIHZhciB1c2VybGVzc1NoYXJlO1xyXG5cclxuICAgIC8vcHVibGljXHJcbiAgICByZXR1cm4ge1xyXG5cclxuICAgICAgICBnZXRQcm9wZXJ0eTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcHJvcGVydHk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgc2V0UHJvcGVydHk6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBwcm9wZXJ0eSA9IHZhbHVlO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIHNhdmVVc2VybGVzc1NoYXJlOiBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICB1c2VybGVzc1NoYXJlID0gZGF0YTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJldHVyblVzZXJsZXNzU2hhcmU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVzZXJsZXNzU2hhcmU7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufTtcclxuXHJcbmFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuZmFjdG9yeShcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIFtzaGFyZVZhcnNCZXR3ZWVuQ3RybF0pOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjgvMTIvMjAxNS5cclxuICovXHJcblxyXG5mdW5jdGlvbiBHZkV2ZW50KGlkLCBldmVudG5hbWUsIGV2ZW50aW1hZ2UsIGF1dGhvcmlkLCBmcm9tLCB1bnRpbCwgbGF0LCBsbmcsIGFkZHJlc3MpIHtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIHRoaXMuZXZlbnRuYW1lID0gZXZlbnRuYW1lO1xyXG4gICAgdGhpcy5ldmVudGltYWdlID0gZXZlbnRpbWFnZTtcclxuICAgIHRoaXMuYXV0aG9yaWQgPSBhdXRob3JpZDtcclxuICAgIHRoaXMuZnJvbSA9IGZyb207XHJcbiAgICB0aGlzLnVudGlsID0gdW50aWw7XHJcbiAgICB0aGlzLmxhdCA9IGxhdDtcclxuICAgIHRoaXMubG5nID0gbG5nO1xyXG4gICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzcztcclxufVxyXG5cclxuR2ZTaGFyZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ldmVudG5hbWU7XHJcbn07IiwiZnVuY3Rpb24gR2ZTaGFyZShpZCwgdXNlcmlkLCBldmVudGlkLCB0aW1lLCBtb29kLCBsYXQsIGxuZywgYWRkcmVzcykge1xyXG4gICAgdGhpcy5pZCA9IGlkO1xyXG4gICAgdGhpcy51c2VyaWQgPSB1c2VyaWQ7XHJcbiAgICB0aGlzLmV2ZW50aWQgPSBldmVudGlkO1xyXG4gICAgdGhpcy50aW1lID0gdGltZTtcclxuICAgIHRoaXMubW9vZCA9IG1vb2Q7XHJcbiAgICB0aGlzLmxhdCA9IGxhdDtcclxuICAgIHRoaXMubG5nID0gbG5nO1xyXG4gICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzcztcclxufVxyXG5cclxuR2ZTaGFyZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VyaWQgKyBcIiAoXCIgKyB0aGlzLnRpbWUgKyBcIilcIjtcclxufTtcclxuIiwiZnVuY3Rpb24gR2ZVc2VyKGlkLCB1c2VybmFtZSwgZW1haWwsIHVzZXJpbWFnZSwgYWdlLCBsYXQsIGxuZywgYWRkcmVzcywgY2hhdCwgYWRtaW4pIHtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgIHRoaXMuZW1haWwgPSBlbWFpbDtcclxuICAgIHRoaXMudXNlcmltYWdlID0gdXNlcmltYWdlO1xyXG4gICAgdGhpcy5hZ2UgPSBhZ2U7XHJcbiAgICB0aGlzLmxhdCA9IGxhdDtcclxuICAgIHRoaXMubG5nID0gbG5nO1xyXG4gICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzcztcclxuICAgIHRoaXMuY2hhdCA9IGNoYXQ7XHJcbiAgICB0aGlzLmFkbWluID0gYWRtaW47XHJcbn1cclxuXHJcbkdmVXNlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VybmFtZTtcclxufTtcclxuIiwiZnVuY3Rpb24gU2VhcmNoUmVzdWx0KGlkLHVzZXJuYW1lKVxyXG57XHJcbiAgICB0aGlzLmlkID0gaWQ7XHJcbiAgICB0aGlzLnVzZXJuYW1lID0gdXNlcm5hbWU7XHJcbn1cclxuU2VhcmNoUmVzdWx0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMudGl0bGU7XHJcbn07XHJcbiIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjIvMTEvMjAxNS5cclxuICovXHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
