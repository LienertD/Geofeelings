(function () {
    "use strict";

    var app = angular.module("geofeelings", ["ngRoute"]);

    app.config(function ($routeProvider) {
        $routeProvider
            .when("/admin", {
                templateUrl: "./controllers/adminController/admin.html"
            }).when("/search", {
                templateUrl: "./controllers/searchController/search.html"
            }).when("/intro", {
                templateUrl: "./controllers/introController/intro.html"
            }).when("/help", {
                templateUrl: "./directives/help.html"
            }).when("/login", {
                templateUrl: "./controllers/loginController/login.html"
            }).when("/register", {
                templateUrl: "./controllers/loginController/register.html"
            }).when("/password", {
                templateUrl: "./controllers/loginController/password.html"
            }).when("/user", {
                templateUrl: "./controllers/userController/user.html"
            }).when("/user/:param", {
                templateUrl: "./controllers/userController/user.html",
                controller: 'userController'
            }).when("/me", {
                templateUrl: "./controllers/userController/me.html"
            }).when("/event", {
                templateUrl: "./controllers/eventController/event.html"
            }).when("/addEvent", {
                templateUrl: "./controllers/eventController/addEvent.html"
            }).when("/location", {
                templateUrl: "./controllers/locationController/location.html"
            }).when("/intro_shared", {
                templateUrl: "./controllers/introController/intro_shared.html"
            }).otherwise({
                redirectTo: "/intro"
            });
    });

    app.directive("searchresult", function () {
        return {
            restrict: 'E',
            templateUrl: 'directives/searchResult.html'
        };
    });

    app.service('sharedProperties', function () {
        var property = 'First';

        return {
            getProperty: function () {
                return property;
            },
            setProperty: function (value) {
                property = value;
            }
        };
    });

})();

/**
 * Created by Jonatan on 6/12/2015.
 */

(function () {
    "use strict";

    var adminController = function ($scope) {

    };

    angular.module("geofeelings").controller("adminController", ["$scope", adminController]);
})();
/**
 * Created by Jonatan on 4/12/2015.
 */


(function () {
    "use strict";

    var eventController = function ($scope) {

    };

    angular.module("geofeelings").controller("eventController", ["$scope", eventController]);
})();
/**
 * Created by Jonatan on 6/12/2015.
 */

(function () {
    "use strict";

    var locationController = function ($scope) {

    };

    angular.module("geofeelings").controller("locationController", ["$scope", locationController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var introController = function ($scope, shareService, $http ) {


        //SMILEY TEKENEN
        $scope.sliderValue = 50;
        $scope.moodWord = null;
        var c = document.getElementById("smileyCanvas");
        var ctx = c.getContext("2d");

        var sadRGB = [152, 30, 30];
        var happyRGB = [70, 161, 73];

        //telkens slidervalue verandert gezichtje tekenen
        $scope.$watch("sliderValue", function () {
            ctx.clearRect(0, 0, c.width, c.height); //canvas clearen voor nieuw frame

            var mood = $scope.sliderValue;
            giveMoodWord();
            //offset positie mond
            var offsetX = c.width / 5;
            var offSetY = c.width / 2.14 + (mood / (c.width / 6));

            //variabelen voor beziercurve (= mond)
            var SPx = offsetX;
            var SPy = offSetY + c.width / 3 - (mood * (c.width / 376.66));
            var H1x = offsetX;
            var H1y = offSetY + (mood * (c.width / 250));
            var H2x = offsetX + ((c.width / 300) * 180);
            var H2y = offSetY + (mood * (c.width / 250));
            var EPx = offsetX + (c.width / 1.666);
            var EPy = offSetY + (c.width / 3) - (mood * (c.width / 376.66));

            //hoofd
            ctx.lineWidth = c.width / 60;
            ctx.beginPath();
            ctx.arc((c.width / 2), (c.width / 2), (c.width / 2.07), 0, 2 * Math.PI);
            ctx.fillStyle = "rgb(" + moodColor(0) + "," + moodColor(1) + "," + moodColor(2) + ")";
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.stroke();

            //mond

            ctx.lineWidth = c.width / 30;
            ctx.beginPath();
            ctx.moveTo(SPx, SPy);
            ctx.bezierCurveTo(H1x, H1y, H2x, H2y, EPx, EPy);
            ctx.strokeStyle = 'black';
            ctx.stroke();
            ctx.lineCap = "round";

            //oog links

            ctx.lineWidth = c.width / 60;
            ctx.beginPath();
            ctx.arc(c.width / 3, c.width / 3, c.width / 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();

            //oog rechts
            ctx.beginPath();
            ctx.arc(c.width / 3 * 2, c.width / 3, c.width / 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();
        });

        var moodColor = function (c) {
            //c: R = 0, G = 1, B = 2

            if (sadRGB[c] > happyRGB[c]) {
                return Math.round(sadRGB[c] - ((sadRGB[c] - happyRGB[c]) * ($scope.sliderValue / 100)));
            }
            else {
                return Math.round(sadRGB[c] + ((happyRGB[c] - sadRGB[c]) * ($scope.sliderValue / 100)));
            }

        };

        var moodwords = ["horrible", "really bad", "bad", "okay", "good", "really good", "excellent"];

        var giveMoodWord = function () {
            if ($scope.sliderValue < 5) {
                $scope.moodWord = moodwords[0];
            }
            else if ($scope.sliderValue < 25) {
                $scope.moodWord = moodwords[1];
            }
            else if ($scope.sliderValue < 40) {
                $scope.moodWord = moodwords[2];
            }
            else if ($scope.sliderValue < 60) {
                $scope.moodWord = moodwords[3];
            }
            else if ($scope.sliderValue < 75) {
                $scope.moodWord = moodwords[4];
            }
            else if ($scope.sliderValue < 95) {
                $scope.moodWord = moodwords[5];
            }
            else {
                $scope.moodWord = moodwords[6];
            }
        };

        $http.get('/auth/user').success(function (data) {
            console.log(data);
            $scope.user = data;
        });

        $scope.postShare = function () {
            navigator.geolocation.getCurrentPosition(function (position) {
                var data = {
                    "userid": $scope.user._id,
                    "eventid": 0,
                    "time": new Date().toISOString(),
                    "mood": $scope.sliderValue,
                    "lat": position.coords.latitude,
                    "lng": position.coords.longitude
                };

                shareService.postShare(data);


            });
        };
    };

    angular.module("geofeelings").controller("introController", ["$scope", "shareService", "$http", introController]);
})();
/**
 * Created by Lienert on 21/12/2015.
 */

(function () {
    "use strict";

    var intro_sharedController = function ($scope, $http) {
        console.log( $scope.sharedShare);

    };
    angular.module("geofeelings").controller("intro_sharedController", ["$scope","$http", intro_sharedController]);
})();
/**
 * Created by Jonatan on 26/11/2015.
 */

(function () {
    "use strict";

    var loginController = function ($scope, $http, $location) {
        $scope.login = function () {
            $http.post('http://localhost:3000/auth/login', {
                username : $scope.username,
                password : $scope.password
            }).success(function (data) {
                $scope.error = data.error;
                $location.path(data.redirect);
            });
        };

        $scope.register = function() {
            $http.post('http://localhost:3000/auth/register', {
                username : $scope.username,
                password : $scope.password,
                email : $scope.email
            }).success(function (data) {
                $scope.error = data.error;
                $location.path(data.redirect);
            });
        };
    };

    angular.module("geofeelings").controller("loginController", ["$scope", "$http", "$location", loginController]);
})();
/**
 * Created by Jonatan on 21/11/2015.
 */

(function () {
    "use strict";

    var mainController = function ($scope) {
        if (navigator.geolocation) {
            $scope.image = "./assets/location_now.png";
            $scope.mapOptions = {
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true
            };

            $scope.map = new google.maps.Map(document.querySelector("#map"), $scope.mapOptions);

            navigator.geolocation.getCurrentPosition(function (position) {
                $scope.map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                $scope.marker = new google.maps.Marker({
                    position: $scope.map.getCenter(),
                    map: $scope.map,
                    icon: $scope.image
                });
            });
        } else {
            //throw exception
        }
    };

    angular.module("geofeelings").controller("mainController", ["$scope", mainController]);
})();
/**
 * Created by Jonatan on 25/11/2015.
 */


(function () {
    "use strict";

    var searchController = function ($scope, searchService, sharedProperties) {

        $scope.searchModel = null;

        $scope.searchOnSubmit = function (formObj) {
            if ($scope.searchModel.length > 0) {
                searchNow();
            }
        };
        $scope.searchOnKeyPress = function () {
            if ($scope.searchModel !== null) {
                searchNow();
            }
        };

        $scope.filterSearchResults = function (i) {
            if ($scope.searchModel === "") {
                return false;
            }

            if (i.username.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                return true;
            }
            if (i.description !== undefined) {
                if (i.description.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                    return true;
                }
            }

            return false;
        };


        var searchNow = function () {
            searchService.search($scope.searchModel).then(onResultsReady);
        };

        var onResultsReady = function (res) {
            $scope.searchResults = res;
        };

        var onResultsError = function (err) {
        };
    };

    angular.module("geofeelings").controller("searchController", ["$scope", "searchService","sharedProperties", searchController]);
})();
/**
 * Created by Jonatan on 21/12/2015.
 */

(function () {
    "use strict";

    var meController = function ($scope, $http, $location) {
        $http.get('/auth/user').success(function(data) {
            $scope.user = data;
            $scope.user.age = new Date($scope.user.age);
            if(data.redirect) {
                $location.path(data.redirect);
            }
        });

        $scope.logout = function() {
            $http.get('/auth/logout').success(function (data) {
                $location.path(data.redirect);
            });
        };

        $scope.save = function(user) {
            // API aanspreken => /api/user
            $http.put('/api/user/' + $scope.user._id, user).success(function (data) {
                if (data.redirect) {
                    $location.path(data.redirect);
                } else {
                    $scope.user = data;
                    $scope.user.age = new Date($scope.user.age);
                }
            });
        };
    };

    angular.module("geofeelings").controller("meController", ["$scope", "$http", "$location", meController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var userController = function ($scope, $location, searchService) {

        $scope.init = function () {
            var userid = $location.search().userid;
            searchService.searchUserFromId(userid).then(userFoundWithId);
            searchService.getSharesByUserId(userid).then(sharesFoundWithId); //IMPLEMENTEREN ALS JONATAN DE API FTIE HEEFT AANGEMAAKT
        };

        var userFoundWithId = function (res) {
            $scope.userfoundwithid = res;

            if (res.lat !== undefined && res.lat !== undefined) {
                $scope.map.setCenter(new google.maps.LatLng(res.lat, res.lng));
                if ($scope.marker !== undefined) {
                    $scope.marker.setMap(null); //verwijdert alle markers eerst
                }
                $scope.marker = new google.maps.Marker({
                    position: {lat: res.lat, lng: res.lng},
                    map: $scope.map,
                    icon: $scope.image
                });
            }
        };

        var giveFeelingsImageArrayNumber = function (res) {
            if (res.mood > 80) {
                return 4;
            }
            else {
                return Math.round(res.mood / 20);
            }
        };

        $scope.test = function(share)
        {
            $scope.map.setCenter(new google.maps.LatLng(share.lat, share.lng));
            $scope.map.setZoom(19);
        };

        var sharesFoundWithId = function (res) {
            console.log(res);

            $scope.shareFoundWithUserId = res;

            //markers plaatsen en kaart verplaatsen naar hun gemiddelde
            var minLat = 100,
                maxLat = 0,
                minLng = 100,
                maxLng = 0,
                teller = 0,
                gemLat = 0,
                gemLng = 0;

            $scope.marker.setMap(null); //verwijdert alle markers eerst

            var feelingImages = ["depressed", "sad", "common", "happy", "excited"];

            res.forEach(function (res) {

                teller++;
                if (res.lat < minLat) {
                    minLat = res.lat;
                }
                if (res.lat > maxLat) {
                    maxLat = res.lat;
                }

                if (res.lng < minLng) {
                    minLng = res.lng;
                }
                if (res.lng > maxLng) {
                    maxLng = res.lng;
                }

                $scope.marker = new google.maps.Marker({
                    position: {lat: res.lat, lng: res.lng},
                    map: $scope.map,
                    icon: "./assets/" + feelingImages[giveFeelingsImageArrayNumber(res)] + ".png"
                });
            });

            if (teller == 1) {
                gemLat = res[0].lat;
                gemLng = res[0].lng;
            }
            else {
                gemLat = ((maxLat - minLat) / 2) + minLat;
                gemLng = ((maxLng - minLng) / 2) + minLng;
            }

            $scope.map.setCenter(new google.maps.LatLng(gemLat, gemLng));
            $scope.map.setZoom(14);
            //klaar met markers plaatsen en kaart verplaatsen naar hun gemiddelde
        };
    };

    angular.module("geofeelings").controller("userController", ["$scope", "$location", "searchService", userController]);
})
();
/**
 * Created by Jonatan on 22/12/2015.
 */

// https://developers.google.com/maps/documentation/geocoding/intro?csw=1#Geocoding
// Dit gebruiken om adressen te vertalen naar lat en lng of omgekeerd
// Waarom? => google maps werkt met lat en lng, wordt zo opgeslaan in de database
(function () {
    "use strict";

    var searchService = function ($http) {

        var search = function (searchString) {
            var url = 'http://localhost:3000/api/user/';

            return $http.get(url).then(function (response) {

                var arSearchResults = [];
                angular.forEach(response.data, function (searchR) {
                    var newSR = new SearchResult(searchR._id, searchR.username);
                    arSearchResults.push(newSR);
                });
                console.log(arSearchResults);
                return arSearchResults;
            });
        };

        var searchUserFromId = function (searchString) {
            var url = 'http://localhost:3000/api/user/' + searchString;
            return $http.get(url).then(function (response) {
                return new GfUser(
                    response.data._id,
                    response.data.username,
                    response.data.email,
                    response.data.userimage,
                    response.data.age,
                    response.data.lat, 
                    response.data.lng,
                    response.data.chat,
                    response.data.admin
                );

            });
        };

        var getSharesByUserId = function (userid) {
            var url = 'http://localhost:3000/api/share/' + userid; //NIEUW PAD!!! (al aangepast)
            return $http.get(url).then(function (response) {

                var sharesfound = [];
                angular.forEach(response.data, function (share) {
                    var newShare = new GFShare(share._id, share.userid, share.eventid, share.time,share.mood, share.lat, share.lng);
                    sharesfound.push(newShare);
                });
                console.log(sharesfound);
                return sharesfound;
            });
        };

        return {
            search: search,
            searchUserFromId: searchUserFromId,
            getSharesByUserId: getSharesByUserId
        };
    };
    angular.module("geofeelings").factory("searchService", ["$http", searchService]);
})();
/**
 * Created by Lienert on 23/12/2015.
 */

(function () {
    "use strict";

    var shareService = function ($http) {

        var postShare = function (data) {

            $http({
                url: 'http://localhost:3000/api/share',
                method: 'POST',
                data: data,
                headers: {'Content-Type': 'application/json'}
            }).
                success(function (serverData) {
                    console.log(serverData);
                });
        };
        return {
            postShare: postShare
        };
    };
    angular.module("geofeelings").factory("shareService", ["$http",shareService]);
})();
function GFShare(id, userid, eventid, time, mood, lat, lng) {
    this.id = id;
    this.userid = userid;
    this.eventid = eventid;
    this.time = time;
    this.mood = mood;
    this.lat = lat;
    this.lng = lng;
}
GFShare.prototype.toString = function () {
    return this.user + " (" + this.time + ")";
};

function GfUser(id, username, email, userimage, age, lat, lng, chat, admin) {
    this.id = id;
    this.username = username;
    this.email = email;
    this.userimage = userimage;
    this.age = age;
    this.lat = lat;
    this.lng = lng;
    this.chat = chat;
    this.admin = admin;
}
GfUser.prototype.toString = function () {
    return this.username;
};

function SearchResult(id,username)
{
    this.id = id;
    this.username = username;
}
SearchResult.prototype.toString = function() {
    return this.title;
};

/**
 * Created by Jonatan on 22/11/2015.
 */

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImFkbWluQ29udHJvbGxlci9hZG1pbkNvbnRyb2xsZXIuanMiLCJldmVudENvbnRyb2xsZXIvZXZlbnRDb250cm9sbGVyLmpzIiwibG9jYXRpb25Db250cm9sbGVyL2xvY2F0aW9uQ29udHJvbGxlci5qcyIsImludHJvQ29udHJvbGxlci9pbnRyb0NvbnRyb2xsZXIuanMiLCJpbnRyb0NvbnRyb2xsZXIvaW50cm9fc2hhcmVkQ29udHJvbGxlci5qcyIsImxvZ2luQ29udHJvbGxlci9sb2dpbkNvbnRyb2xsZXIuanMiLCJtYWluQ29udHJvbGxlci9tYWluQ29udHJvbGxlci5qcyIsInNlYXJjaENvbnRyb2xsZXIvc2VhcmNoQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyL21lQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyL3VzZXJDb250cm9sbGVyLmpzIiwiZ2VvY29kaW5nU2VydmljZS5qcyIsInNlYXJjaFNlcnZpY2UuanMiLCJzaGFyZVNlcnZpY2UuanMiLCJnZlNoYXJlLmpzIiwiZ2ZVc2VyLmpzIiwiU2VhcmNoUmVzdWx0LmpzIiwibWFwRXhjZXB0aW9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNiQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDTkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzFCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1JBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIiwgW1wibmdSb3V0ZVwiXSk7XHJcblxyXG4gICAgYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHJvdXRlUHJvdmlkZXIpIHtcclxuICAgICAgICAkcm91dGVQcm92aWRlclxyXG4gICAgICAgICAgICAud2hlbihcIi9hZG1pblwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2FkbWluQ29udHJvbGxlci9hZG1pbi5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9zZWFyY2hcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9zZWFyY2hDb250cm9sbGVyL3NlYXJjaC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9pbnRyb1wiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2ludHJvQ29udHJvbGxlci9pbnRyby5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9oZWxwXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vZGlyZWN0aXZlcy9oZWxwLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL2xvZ2luXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvbG9naW5Db250cm9sbGVyL2xvZ2luLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3JlZ2lzdGVyXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvbG9naW5Db250cm9sbGVyL3JlZ2lzdGVyLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3Bhc3N3b3JkXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvbG9naW5Db250cm9sbGVyL3Bhc3N3b3JkLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3VzZXJcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy91c2VyQ29udHJvbGxlci91c2VyLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3VzZXIvOnBhcmFtXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvdXNlckNvbnRyb2xsZXIvdXNlci5odG1sXCIsXHJcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAndXNlckNvbnRyb2xsZXInXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvbWVcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy91c2VyQ29udHJvbGxlci9tZS5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9ldmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2V2ZW50Q29udHJvbGxlci9ldmVudC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9hZGRFdmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2V2ZW50Q29udHJvbGxlci9hZGRFdmVudC5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9sb2NhdGlvblwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2xvY2F0aW9uQ29udHJvbGxlci9sb2NhdGlvbi5odG1sXCJcclxuICAgICAgICAgICAgfSkud2hlbihcIi9pbnRyb19zaGFyZWRcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9pbnRyb0NvbnRyb2xsZXIvaW50cm9fc2hhcmVkLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS5vdGhlcndpc2Uoe1xyXG4gICAgICAgICAgICAgICAgcmVkaXJlY3RUbzogXCIvaW50cm9cIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC5kaXJlY3RpdmUoXCJzZWFyY2hyZXN1bHRcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnZGlyZWN0aXZlcy9zZWFyY2hSZXN1bHQuaHRtbCdcclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcblxyXG4gICAgYXBwLnNlcnZpY2UoJ3NoYXJlZFByb3BlcnRpZXMnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHByb3BlcnR5ID0gJ0ZpcnN0JztcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZ2V0UHJvcGVydHk6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2V0UHJvcGVydHk6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgcHJvcGVydHkgPSB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuXHJcbn0pKCk7XHJcbiIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gNi8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgYWRtaW5Db250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiYWRtaW5Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBhZG1pbkNvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDQvMTIvMjAxNS5cclxuICovXHJcblxyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBldmVudENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XHJcblxyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJldmVudENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIGV2ZW50Q29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gNi8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgbG9jYXRpb25Db250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSkge1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwibG9jYXRpb25Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBsb2NhdGlvbkNvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDEvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGludHJvQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsIHNoYXJlU2VydmljZSwgJGh0dHAgKSB7XHJcblxyXG5cclxuICAgICAgICAvL1NNSUxFWSBURUtFTkVOXHJcbiAgICAgICAgJHNjb3BlLnNsaWRlclZhbHVlID0gNTA7XHJcbiAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbnVsbDtcclxuICAgICAgICB2YXIgYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwic21pbGV5Q2FudmFzXCIpO1xyXG4gICAgICAgIHZhciBjdHggPSBjLmdldENvbnRleHQoXCIyZFwiKTtcclxuXHJcbiAgICAgICAgdmFyIHNhZFJHQiA9IFsxNTIsIDMwLCAzMF07XHJcbiAgICAgICAgdmFyIGhhcHB5UkdCID0gWzcwLCAxNjEsIDczXTtcclxuXHJcbiAgICAgICAgLy90ZWxrZW5zIHNsaWRlcnZhbHVlIHZlcmFuZGVydCBnZXppY2h0amUgdGVrZW5lblxyXG4gICAgICAgICRzY29wZS4kd2F0Y2goXCJzbGlkZXJWYWx1ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOyAvL2NhbnZhcyBjbGVhcmVuIHZvb3IgbmlldXcgZnJhbWVcclxuXHJcbiAgICAgICAgICAgIHZhciBtb29kID0gJHNjb3BlLnNsaWRlclZhbHVlO1xyXG4gICAgICAgICAgICBnaXZlTW9vZFdvcmQoKTtcclxuICAgICAgICAgICAgLy9vZmZzZXQgcG9zaXRpZSBtb25kXHJcbiAgICAgICAgICAgIHZhciBvZmZzZXRYID0gYy53aWR0aCAvIDU7XHJcbiAgICAgICAgICAgIHZhciBvZmZTZXRZID0gYy53aWR0aCAvIDIuMTQgKyAobW9vZCAvIChjLndpZHRoIC8gNikpO1xyXG5cclxuICAgICAgICAgICAgLy92YXJpYWJlbGVuIHZvb3IgYmV6aWVyY3VydmUgKD0gbW9uZClcclxuICAgICAgICAgICAgdmFyIFNQeCA9IG9mZnNldFg7XHJcbiAgICAgICAgICAgIHZhciBTUHkgPSBvZmZTZXRZICsgYy53aWR0aCAvIDMgLSAobW9vZCAqIChjLndpZHRoIC8gMzc2LjY2KSk7XHJcbiAgICAgICAgICAgIHZhciBIMXggPSBvZmZzZXRYO1xyXG4gICAgICAgICAgICB2YXIgSDF5ID0gb2ZmU2V0WSArIChtb29kICogKGMud2lkdGggLyAyNTApKTtcclxuICAgICAgICAgICAgdmFyIEgyeCA9IG9mZnNldFggKyAoKGMud2lkdGggLyAzMDApICogMTgwKTtcclxuICAgICAgICAgICAgdmFyIEgyeSA9IG9mZlNldFkgKyAobW9vZCAqIChjLndpZHRoIC8gMjUwKSk7XHJcbiAgICAgICAgICAgIHZhciBFUHggPSBvZmZzZXRYICsgKGMud2lkdGggLyAxLjY2Nik7XHJcbiAgICAgICAgICAgIHZhciBFUHkgPSBvZmZTZXRZICsgKGMud2lkdGggLyAzKSAtIChtb29kICogKGMud2lkdGggLyAzNzYuNjYpKTtcclxuXHJcbiAgICAgICAgICAgIC8vaG9vZmRcclxuICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGMud2lkdGggLyA2MDtcclxuICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICAgICAgICBjdHguYXJjKChjLndpZHRoIC8gMiksIChjLndpZHRoIC8gMiksIChjLndpZHRoIC8gMi4wNyksIDAsIDIgKiBNYXRoLlBJKTtcclxuICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IFwicmdiKFwiICsgbW9vZENvbG9yKDApICsgXCIsXCIgKyBtb29kQ29sb3IoMSkgKyBcIixcIiArIG1vb2RDb2xvcigyKSArIFwiKVwiO1xyXG4gICAgICAgICAgICBjdHguZmlsbCgpO1xyXG4gICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnd2hpdGUnO1xyXG4gICAgICAgICAgICBjdHguc3Ryb2tlKCk7XHJcblxyXG4gICAgICAgICAgICAvL21vbmRcclxuXHJcbiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBjLndpZHRoIC8gMzA7XHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4Lm1vdmVUbyhTUHgsIFNQeSk7XHJcbiAgICAgICAgICAgIGN0eC5iZXppZXJDdXJ2ZVRvKEgxeCwgSDF5LCBIMngsIEgyeSwgRVB4LCBFUHkpO1xyXG4gICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnYmxhY2snO1xyXG4gICAgICAgICAgICBjdHguc3Ryb2tlKCk7XHJcbiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gXCJyb3VuZFwiO1xyXG5cclxuICAgICAgICAgICAgLy9vb2cgbGlua3NcclxuXHJcbiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBjLndpZHRoIC8gNjA7XHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4LmFyYyhjLndpZHRoIC8gMywgYy53aWR0aCAvIDMsIGMud2lkdGggLyAxNSwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ2JsYWNrJztcclxuICAgICAgICAgICAgY3R4LmZpbGwoKTtcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpO1xyXG5cclxuICAgICAgICAgICAgLy9vb2cgcmVjaHRzXHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4LmFyYyhjLndpZHRoIC8gMyAqIDIsIGMud2lkdGggLyAzLCBjLndpZHRoIC8gMTUsIDAsIDIgKiBNYXRoLlBJKTtcclxuICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdibGFjayc7XHJcbiAgICAgICAgICAgIGN0eC5maWxsKCk7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIG1vb2RDb2xvciA9IGZ1bmN0aW9uIChjKSB7XHJcbiAgICAgICAgICAgIC8vYzogUiA9IDAsIEcgPSAxLCBCID0gMlxyXG5cclxuICAgICAgICAgICAgaWYgKHNhZFJHQltjXSA+IGhhcHB5UkdCW2NdKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChzYWRSR0JbY10gLSAoKHNhZFJHQltjXSAtIGhhcHB5UkdCW2NdKSAqICgkc2NvcGUuc2xpZGVyVmFsdWUgLyAxMDApKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChzYWRSR0JbY10gKyAoKGhhcHB5UkdCW2NdIC0gc2FkUkdCW2NdKSAqICgkc2NvcGUuc2xpZGVyVmFsdWUgLyAxMDApKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIG1vb2R3b3JkcyA9IFtcImhvcnJpYmxlXCIsIFwicmVhbGx5IGJhZFwiLCBcImJhZFwiLCBcIm9rYXlcIiwgXCJnb29kXCIsIFwicmVhbGx5IGdvb2RcIiwgXCJleGNlbGxlbnRcIl07XHJcblxyXG4gICAgICAgIHZhciBnaXZlTW9vZFdvcmQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA1KSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbMF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoJHNjb3BlLnNsaWRlclZhbHVlIDwgMjUpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1sxXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA0MCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzJdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDYwKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbM107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoJHNjb3BlLnNsaWRlclZhbHVlIDwgNzUpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1s0XTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA5NSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzZdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJGh0dHAuZ2V0KCcvYXV0aC91c2VyJykuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSBkYXRhO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkc2NvcGUucG9zdFNoYXJlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKGZ1bmN0aW9uIChwb3NpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJ1c2VyaWRcIjogJHNjb3BlLnVzZXIuX2lkLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiZXZlbnRpZFwiOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIFwidGltZVwiOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICAgICAgICAgICAgXCJtb29kXCI6ICRzY29wZS5zbGlkZXJWYWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICBcImxhdFwiOiBwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgXCJsbmdcIjogcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBzaGFyZVNlcnZpY2UucG9zdFNoYXJlKGRhdGEpO1xyXG5cclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImludHJvQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCJzaGFyZVNlcnZpY2VcIiwgXCIkaHR0cFwiLCBpbnRyb0NvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBMaWVuZXJ0IG9uIDIxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBpbnRyb19zaGFyZWRDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgJGh0dHApIHtcclxuICAgICAgICBjb25zb2xlLmxvZyggJHNjb3BlLnNoYXJlZFNoYXJlKTtcclxuXHJcbiAgICB9O1xyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiaW50cm9fc2hhcmVkQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIixcIiRodHRwXCIsIGludHJvX3NoYXJlZENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDI2LzExLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBsb2dpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkaHR0cCwgJGxvY2F0aW9uKSB7XHJcbiAgICAgICAgJHNjb3BlLmxvZ2luID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkaHR0cC5wb3N0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXV0aC9sb2dpbicsIHtcclxuICAgICAgICAgICAgICAgIHVzZXJuYW1lIDogJHNjb3BlLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQgOiAkc2NvcGUucGFzc3dvcmRcclxuICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcclxuICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUucmVnaXN0ZXIgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgJGh0dHAucG9zdCgnaHR0cDovL2xvY2FsaG9zdDozMDAwL2F1dGgvcmVnaXN0ZXInLCB7XHJcbiAgICAgICAgICAgICAgICB1c2VybmFtZSA6ICRzY29wZS51c2VybmFtZSxcclxuICAgICAgICAgICAgICAgIHBhc3N3b3JkIDogJHNjb3BlLnBhc3N3b3JkLFxyXG4gICAgICAgICAgICAgICAgZW1haWwgOiAkc2NvcGUuZW1haWxcclxuICAgICAgICAgICAgfSkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcclxuICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJsb2dpbkNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgbG9naW5Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyMS8xMS8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgbWFpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlKSB7XHJcbiAgICAgICAgaWYgKG5hdmlnYXRvci5nZW9sb2NhdGlvbikge1xyXG4gICAgICAgICAgICAkc2NvcGUuaW1hZ2UgPSBcIi4vYXNzZXRzL2xvY2F0aW9uX25vdy5wbmdcIjtcclxuICAgICAgICAgICAgJHNjb3BlLm1hcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICB6b29tOiAxNSxcclxuICAgICAgICAgICAgICAgIG1hcFR5cGVJZDogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVAsXHJcbiAgICAgICAgICAgICAgICBkaXNhYmxlRGVmYXVsdFVJOiB0cnVlXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAkc2NvcGUubWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI21hcFwiKSwgJHNjb3BlLm1hcE9wdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXAuc2V0Q2VudGVyKG5ldyBnb29nbGUubWFwcy5MYXRMbmcocG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLCBwb3NpdGlvbi5jb29yZHMubG9uZ2l0dWRlKSk7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICRzY29wZS5tYXAuZ2V0Q2VudGVyKCksXHJcbiAgICAgICAgICAgICAgICAgICAgbWFwOiAkc2NvcGUubWFwLFxyXG4gICAgICAgICAgICAgICAgICAgIGljb246ICRzY29wZS5pbWFnZVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vdGhyb3cgZXhjZXB0aW9uXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJtYWluQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgbWFpbkNvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDI1LzExLzIwMTUuXHJcbiAqL1xyXG5cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgc2VhcmNoQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsIHNlYXJjaFNlcnZpY2UsIHNoYXJlZFByb3BlcnRpZXMpIHtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE1vZGVsID0gbnVsbDtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE9uU3VibWl0ID0gZnVuY3Rpb24gKGZvcm1PYmopIHtcclxuICAgICAgICAgICAgaWYgKCRzY29wZS5zZWFyY2hNb2RlbC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hOb3coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE9uS2V5UHJlc3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2VhcmNoTW9kZWwgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaE5vdygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmZpbHRlclNlYXJjaFJlc3VsdHMgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgICBpZiAoJHNjb3BlLnNlYXJjaE1vZGVsID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpLnVzZXJuYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigkc2NvcGUuc2VhcmNoTW9kZWwudG9Mb2NhbGVMb3dlckNhc2UoKSkgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGkuZGVzY3JpcHRpb24gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGkuZGVzY3JpcHRpb24udG9Mb3dlckNhc2UoKS5pbmRleE9mKCRzY29wZS5zZWFyY2hNb2RlbC50b0xvY2FsZUxvd2VyQ2FzZSgpKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9O1xyXG5cclxuXHJcbiAgICAgICAgdmFyIHNlYXJjaE5vdyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgc2VhcmNoU2VydmljZS5zZWFyY2goJHNjb3BlLnNlYXJjaE1vZGVsKS50aGVuKG9uUmVzdWx0c1JlYWR5KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgb25SZXN1bHRzUmVhZHkgPSBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5zZWFyY2hSZXN1bHRzID0gcmVzO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBvblJlc3VsdHNFcnJvciA9IGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJzZWFyY2hDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcInNlYXJjaFNlcnZpY2VcIixcInNoYXJlZFByb3BlcnRpZXNcIiwgc2VhcmNoQ29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjEvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIG1lQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRodHRwLCAkbG9jYXRpb24pIHtcclxuICAgICAgICAkaHR0cC5nZXQoJy9hdXRoL3VzZXInKS5zdWNjZXNzKGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSBkYXRhO1xyXG4gICAgICAgICAgICAkc2NvcGUudXNlci5hZ2UgPSBuZXcgRGF0ZSgkc2NvcGUudXNlci5hZ2UpO1xyXG4gICAgICAgICAgICBpZihkYXRhLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkc2NvcGUubG9nb3V0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldCgnL2F1dGgvbG9nb3V0Jykuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5zYXZlID0gZnVuY3Rpb24odXNlcikge1xyXG4gICAgICAgICAgICAvLyBBUEkgYWFuc3ByZWtlbiA9PiAvYXBpL3VzZXJcclxuICAgICAgICAgICAgJGh0dHAucHV0KCcvYXBpL3VzZXIvJyArICRzY29wZS51c2VyLl9pZCwgdXNlcikuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyLmFnZSA9IG5ldyBEYXRlKCRzY29wZS51c2VyLmFnZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcIm1lQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBtZUNvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDEvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIHVzZXJDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgJGxvY2F0aW9uLCBzZWFyY2hTZXJ2aWNlKSB7XHJcblxyXG4gICAgICAgICRzY29wZS5pbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdXNlcmlkID0gJGxvY2F0aW9uLnNlYXJjaCgpLnVzZXJpZDtcclxuICAgICAgICAgICAgc2VhcmNoU2VydmljZS5zZWFyY2hVc2VyRnJvbUlkKHVzZXJpZCkudGhlbih1c2VyRm91bmRXaXRoSWQpO1xyXG4gICAgICAgICAgICBzZWFyY2hTZXJ2aWNlLmdldFNoYXJlc0J5VXNlcklkKHVzZXJpZCkudGhlbihzaGFyZXNGb3VuZFdpdGhJZCk7IC8vSU1QTEVNRU5URVJFTiBBTFMgSk9OQVRBTiBERSBBUEkgRlRJRSBIRUVGVCBBQU5HRU1BQUtUXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHVzZXJGb3VuZFdpdGhJZCA9IGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgJHNjb3BlLnVzZXJmb3VuZHdpdGhpZCA9IHJlcztcclxuXHJcbiAgICAgICAgICAgIGlmIChyZXMubGF0ICE9PSB1bmRlZmluZWQgJiYgcmVzLmxhdCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubWFwLnNldENlbnRlcihuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHJlcy5sYXQsIHJlcy5sbmcpKTtcclxuICAgICAgICAgICAgICAgIGlmICgkc2NvcGUubWFya2VyICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubWFya2VyLnNldE1hcChudWxsKTsgLy92ZXJ3aWpkZXJ0IGFsbGUgbWFya2VycyBlZXJzdFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiB7bGF0OiByZXMubGF0LCBsbmc6IHJlcy5sbmd9LFxyXG4gICAgICAgICAgICAgICAgICAgIG1hcDogJHNjb3BlLm1hcCxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOiAkc2NvcGUuaW1hZ2VcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGdpdmVGZWVsaW5nc0ltYWdlQXJyYXlOdW1iZXIgPSBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgIGlmIChyZXMubW9vZCA+IDgwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gNDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHJlcy5tb29kIC8gMjApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnRlc3QgPSBmdW5jdGlvbihzaGFyZSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgICRzY29wZS5tYXAuc2V0Q2VudGVyKG5ldyBnb29nbGUubWFwcy5MYXRMbmcoc2hhcmUubGF0LCBzaGFyZS5sbmcpKTtcclxuICAgICAgICAgICAgJHNjb3BlLm1hcC5zZXRab29tKDE5KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgc2hhcmVzRm91bmRXaXRoSWQgPSBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XHJcblxyXG4gICAgICAgICAgICAkc2NvcGUuc2hhcmVGb3VuZFdpdGhVc2VySWQgPSByZXM7XHJcblxyXG4gICAgICAgICAgICAvL21hcmtlcnMgcGxhYXRzZW4gZW4ga2FhcnQgdmVycGxhYXRzZW4gbmFhciBodW4gZ2VtaWRkZWxkZVxyXG4gICAgICAgICAgICB2YXIgbWluTGF0ID0gMTAwLFxyXG4gICAgICAgICAgICAgICAgbWF4TGF0ID0gMCxcclxuICAgICAgICAgICAgICAgIG1pbkxuZyA9IDEwMCxcclxuICAgICAgICAgICAgICAgIG1heExuZyA9IDAsXHJcbiAgICAgICAgICAgICAgICB0ZWxsZXIgPSAwLFxyXG4gICAgICAgICAgICAgICAgZ2VtTGF0ID0gMCxcclxuICAgICAgICAgICAgICAgIGdlbUxuZyA9IDA7XHJcblxyXG4gICAgICAgICAgICAkc2NvcGUubWFya2VyLnNldE1hcChudWxsKTsgLy92ZXJ3aWpkZXJ0IGFsbGUgbWFya2VycyBlZXJzdFxyXG5cclxuICAgICAgICAgICAgdmFyIGZlZWxpbmdJbWFnZXMgPSBbXCJkZXByZXNzZWRcIiwgXCJzYWRcIiwgXCJjb21tb25cIiwgXCJoYXBweVwiLCBcImV4Y2l0ZWRcIl07XHJcblxyXG4gICAgICAgICAgICByZXMuZm9yRWFjaChmdW5jdGlvbiAocmVzKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGVsbGVyKys7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLmxhdCA8IG1pbkxhdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1pbkxhdCA9IHJlcy5sYXQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLmxhdCA+IG1heExhdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1heExhdCA9IHJlcy5sYXQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5sbmcgPCBtaW5MbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBtaW5MbmcgPSByZXMubG5nO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5sbmcgPiBtYXhMbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBtYXhMbmcgPSByZXMubG5nO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjoge2xhdDogcmVzLmxhdCwgbG5nOiByZXMubG5nfSxcclxuICAgICAgICAgICAgICAgICAgICBtYXA6ICRzY29wZS5tYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogXCIuL2Fzc2V0cy9cIiArIGZlZWxpbmdJbWFnZXNbZ2l2ZUZlZWxpbmdzSW1hZ2VBcnJheU51bWJlcihyZXMpXSArIFwiLnBuZ1wiXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGVsbGVyID09IDEpIHtcclxuICAgICAgICAgICAgICAgIGdlbUxhdCA9IHJlc1swXS5sYXQ7XHJcbiAgICAgICAgICAgICAgICBnZW1MbmcgPSByZXNbMF0ubG5nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZ2VtTGF0ID0gKChtYXhMYXQgLSBtaW5MYXQpIC8gMikgKyBtaW5MYXQ7XHJcbiAgICAgICAgICAgICAgICBnZW1MbmcgPSAoKG1heExuZyAtIG1pbkxuZykgLyAyKSArIG1pbkxuZztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgJHNjb3BlLm1hcC5zZXRDZW50ZXIobmV3IGdvb2dsZS5tYXBzLkxhdExuZyhnZW1MYXQsIGdlbUxuZykpO1xyXG4gICAgICAgICAgICAkc2NvcGUubWFwLnNldFpvb20oMTQpO1xyXG4gICAgICAgICAgICAvL2tsYWFyIG1ldCBtYXJrZXJzIHBsYWF0c2VuIGVuIGthYXJ0IHZlcnBsYWF0c2VuIG5hYXIgaHVuIGdlbWlkZGVsZGVcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJ1c2VyQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkbG9jYXRpb25cIiwgXCJzZWFyY2hTZXJ2aWNlXCIsIHVzZXJDb250cm9sbGVyXSk7XHJcbn0pXHJcbigpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjIvMTIvMjAxNS5cclxuICovXHJcblxyXG4vLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9tYXBzL2RvY3VtZW50YXRpb24vZ2VvY29kaW5nL2ludHJvP2Nzdz0xI0dlb2NvZGluZ1xyXG4vLyBEaXQgZ2VicnVpa2VuIG9tIGFkcmVzc2VuIHRlIHZlcnRhbGVuIG5hYXIgbGF0IGVuIGxuZyBvZiBvbWdla2VlcmRcclxuLy8gV2Fhcm9tPyA9PiBnb29nbGUgbWFwcyB3ZXJrdCBtZXQgbGF0IGVuIGxuZywgd29yZHQgem8gb3BnZXNsYWFuIGluIGRlIGRhdGFiYXNlIiwiKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBzZWFyY2hTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwKSB7XHJcblxyXG4gICAgICAgIHZhciBzZWFyY2ggPSBmdW5jdGlvbiAoc2VhcmNoU3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS91c2VyLyc7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgYXJTZWFyY2hSZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2gocmVzcG9uc2UuZGF0YSwgZnVuY3Rpb24gKHNlYXJjaFIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U1IgPSBuZXcgU2VhcmNoUmVzdWx0KHNlYXJjaFIuX2lkLCBzZWFyY2hSLnVzZXJuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBhclNlYXJjaFJlc3VsdHMucHVzaChuZXdTUik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGFyU2VhcmNoUmVzdWx0cyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXJTZWFyY2hSZXN1bHRzO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgc2VhcmNoVXNlckZyb21JZCA9IGZ1bmN0aW9uIChzZWFyY2hTdHJpbmcpIHtcclxuICAgICAgICAgICAgdmFyIHVybCA9ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3VzZXIvJyArIHNlYXJjaFN0cmluZztcclxuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEdmVXNlcihcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLl9pZCxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZW1haWwsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS51c2VyaW1hZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5hZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5sYXQsIFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEubG5nLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuY2hhdCxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFkbWluXHJcbiAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGdldFNoYXJlc0J5VXNlcklkID0gZnVuY3Rpb24gKHVzZXJpZCkge1xyXG4gICAgICAgICAgICB2YXIgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvc2hhcmUvJyArIHVzZXJpZDsgLy9OSUVVVyBQQUQhISEgKGFsIGFhbmdlcGFzdClcclxuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHNoYXJlc2ZvdW5kID0gW107XHJcbiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2gocmVzcG9uc2UuZGF0YSwgZnVuY3Rpb24gKHNoYXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1NoYXJlID0gbmV3IEdGU2hhcmUoc2hhcmUuX2lkLCBzaGFyZS51c2VyaWQsIHNoYXJlLmV2ZW50aWQsIHNoYXJlLnRpbWUsc2hhcmUubW9vZCwgc2hhcmUubGF0LCBzaGFyZS5sbmcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNoYXJlc2ZvdW5kLnB1c2gobmV3U2hhcmUpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzaGFyZXNmb3VuZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcmVzZm91bmQ7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHNlYXJjaDogc2VhcmNoLFxyXG4gICAgICAgICAgICBzZWFyY2hVc2VyRnJvbUlkOiBzZWFyY2hVc2VyRnJvbUlkLFxyXG4gICAgICAgICAgICBnZXRTaGFyZXNCeVVzZXJJZDogZ2V0U2hhcmVzQnlVc2VySWRcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuZmFjdG9yeShcInNlYXJjaFNlcnZpY2VcIiwgW1wiJGh0dHBcIiwgc2VhcmNoU2VydmljZV0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IExpZW5lcnQgb24gMjMvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIHNoYXJlU2VydmljZSA9IGZ1bmN0aW9uICgkaHR0cCkge1xyXG5cclxuICAgICAgICB2YXIgcG9zdFNoYXJlID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuXHJcbiAgICAgICAgICAgICRodHRwKHtcclxuICAgICAgICAgICAgICAgIHVybDogJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvc2hhcmUnLFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLFxyXG4gICAgICAgICAgICAgICAgaGVhZGVyczogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9XHJcbiAgICAgICAgICAgIH0pLlxyXG4gICAgICAgICAgICAgICAgc3VjY2VzcyhmdW5jdGlvbiAoc2VydmVyRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNlcnZlckRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwb3N0U2hhcmU6IHBvc3RTaGFyZVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5mYWN0b3J5KFwic2hhcmVTZXJ2aWNlXCIsIFtcIiRodHRwXCIsc2hhcmVTZXJ2aWNlXSk7XHJcbn0pKCk7IiwiZnVuY3Rpb24gR0ZTaGFyZShpZCwgdXNlcmlkLCBldmVudGlkLCB0aW1lLCBtb29kLCBsYXQsIGxuZykge1xyXG4gICAgdGhpcy5pZCA9IGlkO1xyXG4gICAgdGhpcy51c2VyaWQgPSB1c2VyaWQ7XHJcbiAgICB0aGlzLmV2ZW50aWQgPSBldmVudGlkO1xyXG4gICAgdGhpcy50aW1lID0gdGltZTtcclxuICAgIHRoaXMubW9vZCA9IG1vb2Q7XHJcbiAgICB0aGlzLmxhdCA9IGxhdDtcclxuICAgIHRoaXMubG5nID0gbG5nO1xyXG59XHJcbkdGU2hhcmUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlciArIFwiIChcIiArIHRoaXMudGltZSArIFwiKVwiO1xyXG59O1xyXG4iLCJmdW5jdGlvbiBHZlVzZXIoaWQsIHVzZXJuYW1lLCBlbWFpbCwgdXNlcmltYWdlLCBhZ2UsIGxhdCwgbG5nLCBjaGF0LCBhZG1pbikge1xyXG4gICAgdGhpcy5pZCA9IGlkO1xyXG4gICAgdGhpcy51c2VybmFtZSA9IHVzZXJuYW1lO1xyXG4gICAgdGhpcy5lbWFpbCA9IGVtYWlsO1xyXG4gICAgdGhpcy51c2VyaW1hZ2UgPSB1c2VyaW1hZ2U7XHJcbiAgICB0aGlzLmFnZSA9IGFnZTtcclxuICAgIHRoaXMubGF0ID0gbGF0O1xyXG4gICAgdGhpcy5sbmcgPSBsbmc7XHJcbiAgICB0aGlzLmNoYXQgPSBjaGF0O1xyXG4gICAgdGhpcy5hZG1pbiA9IGFkbWluO1xyXG59XHJcbkdmVXNlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VybmFtZTtcclxufTtcclxuIiwiZnVuY3Rpb24gU2VhcmNoUmVzdWx0KGlkLHVzZXJuYW1lKVxyXG57XHJcbiAgICB0aGlzLmlkID0gaWQ7XHJcbiAgICB0aGlzLnVzZXJuYW1lID0gdXNlcm5hbWU7XHJcbn1cclxuU2VhcmNoUmVzdWx0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMudGl0bGU7XHJcbn07XHJcbiIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjIvMTEvMjAxNS5cclxuICovXHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
